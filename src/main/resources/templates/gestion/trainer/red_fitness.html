<!DOCTYPE html>
<html lang="en-us"
	  xmlns:th="http://www.thymeleaf.org"
	  th:with="version = ${#servletContext.getAttribute('version')}">
<head>
    <title>Mis clientes</title>
    <th:block th:insert="html-commons/tr/meta :: fg-meta"></th:block>
    <th:block th:insert="html-commons/tr/css  :: fg-css"></th:block>
</head>
<style>
    .trash-nb{
        border-left: 1px solid transparent !important;
        border-top: 1px solid transparent !important;
        border-bottom: 1px solid transparent !important;
    }

    .tooltip-inner {
        max-width: 250px !important;
        min-width: 140px !important;
    }

    .popover{
        max-width: 400px !important;
        min-width: 140px !important;
    }
</style>
<body>
<th:block th:insert="html-commons/in/left-panel::fg-menu-desk"></th:block>
<th:block th:insert="html-commons/in/left-panel::fg-menu-mob"></th:block>

<!-- MAIN PANEL -->
<div id="main-content" role="main">
    <!-- MAIN CONTENT -->
    <div id="wrapper">
        <header>
            <ul class="nav nav-pills">
                <li class="active col-md-2"><a href="#">listado</a></li>
                <li class="col-md-2"><a href="#">videos</a></li>
                <li class="col-md-3"><a href="#">rutinario</a></li>
                <li class="col-md-2"><a href="#">audios</a></li>
                <li class="col-md-3"><a href="#">planes prediseñados</a></li>
            </ul>
        </header>
        <div class="container-t">
            <div class="options">
                <img rel="tooltip" data-placement="bottom" title="Enviar notificación general" class="svg svg-opcs" onclick="preNotificacionGeneral()" th:src="@{/img/iconos/icon_chat.svg}+'?'+${version}">
                <img rel="tooltip" data-placement="bottom" title="Exportar la base de datos de atletas a Excel" class="svg svg-opcs" onclick="exportarListadoAExcel()" th:src="@{/img/iconos/icon_candado.svg}+'?'+${version}">
            </div>
            <div class="" style="padding-bottom: 20px">
                <form id="frm_busqueda">
                    <div class="input-group">
                        <input class="form-control" type="text" id="Nombres" name="Nombres">
                        <div class="input-group-btn">
                            <button class="btn btn-default" type="button" id="btnFiltrar">BUSCAR</button>
                        </div>
                    </div>
                </form>
            </div>
            <fieldset>
                <section>
                    <div class="row" id="view_list">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <table id="tblRegistros" data-mobile-responsive="true" class="table table-bordered table-condensed table-trainer">
                                <thead>
                                <tr>
                                    <th data-formatter="fttDesactivar" data-field="id" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="5%" class="trash">
                                    </th>
                                    <th data-formatter="fttNota" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="5%">Notas
                                    </th>
                                    <th data-formatter="formatterFechaInicialPlanificacion" data-field="fechaInicialPlanificacion" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="10%"><img class="svg" title="Fecha inicio de planificación" rel="tooltip" th:src="@{/img/iconos/icon_calendar.svg}+'?'+${version}">
                                    </th>
                                    <th data-formatter="formatterFechaFinalPlanificacion" data-field="fechaFinalPlanificacion" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="10%"><img class="svg" title="Fecha fin de planificación" rel="tooltip" th:src="@{/img/iconos/icon_calendar.svg}+'?'+${version}">
                                    </th>
                                    <th data-formatter="linkFormatter" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="25%">Nombre y apellidos
                                    </th>
                                    <th data-formatter="fttNp" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="5%">N.P
                                    </th>
                                    <th data-formatter="fttPlantillas" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="5%">Plantillas
                                    </th>
                                    <th data-formatter="fttMeses" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Historial
                                    </th>
                                    <th data-formatter="fttTemporada" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Temporada
                                    </th>
                                    <th data-formatter="fttEnviarCorreo" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Enviar Correo
                                    </th>
                                    <th data-field="cliMovil" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Teléfono
                                    </th>
                                </tr>
                              </thead>
                            </table>
                        </div>
                    </div>
                </section>
            </fieldset>
        </div>
    </div>
    <!-- END MAIN CONTENT -->
</div>
<!-- MODALS -->
<div class="modal fade" id="mdlNota" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button " class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>Añada la nota</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="">
                    <textarea name="NotaCliente" id="NotaCliente" cols="30" rows="3" class="form-control" maxlength="200"></textarea>
                </div>
                <br>
                <em>Máximo 200 caracteres</em>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md" onclick="actualizarNota()">GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>
</div>
<!-- MODAL MOSTRAR RUTINAS PLANTILLA -->
<div class="modal fade" id="myModalPlantillas" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header txt-color-white bg-color-teal">
                <button type="button" class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>Mis Plantillas Rutina</strong></h4>
                <span id="CorreoCliente" hidden="hidden"></span>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div id="Plantillas" class="row">
                    <!-- CONTENIDO DE LA MINI PLANTILLA -->
                </div>
                <div id="spRaw3" class="form-group">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END MODAL CREAR MINI RUTINA -->
<!-- MODAL PARA RUTINAS DE TIPO GENERAL -->
<div class="modal fade" id="myModalRutGen" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header txt-color-white bg-color-teal">
                <button type="button" class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove" style="color: black !important;"></span></button>
                <h4 class="modal-title text-align-center"><strong style="color: black !important;">Generación de rutina</strong></h4>

            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <form id="frm_nue_rut_gen" action="javascript:void(0);">
                    <div class="row">
                        <div class="col col-md-12">
                            <div class="col col-md-6">
                                <label for="RutFechaInicio">Fecha inicio:</label>
                                <input id="RutFechaInicio" name="RutFechaInicio" type="date" class="form-control">
                            </div>
                            <div class="col col-md-6">
                                <label for="RutFechaFinal">Fecha fin:</label>
                                <input id="RutFechaFinal" name="RutFechaFinal" type="date" class="form-control">
                            </div>
                            <div style="margin-top:10px" class="row text-center col-md-12 padding-top-10">Total semanas: <span id="MacroTotalSemanas">0</span></div>
                        </div>
                    </div>
                </form>
                <div id="spRaw4" class="form-group">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="crearPrimeraRutinaGeneral(this)" class="btn btn-primary">CREAR RUTINA</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlCorreoGeneral" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button " class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>NOTIFICAR</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <form id="frm_notif_gen" action="javascript:void(0);">
                    <div class="form-group">
                        <label class="">ASUNTO:</label>
                        <input name="CPAsunto" id="CPAsunto" maxlength="100" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="">MENSAJE:</label>
                        <textarea name="CPCuerpo" id="CPCuerpo" maxlength="2000" cols="30" rows="8" class="form-control"></textarea>
                    </div>
                    <input type="number" id="InpTipoNotificacion" class="hidden">
                    <input type="text" id="InpCliId" class="hidden">
                    <input type="text" id="InpCliCorreo" class="hidden">
                </form>
                <em>Máximo 2000 caracteres</em>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md" onclick="enviarNotificacion()">ENVIAR NOTIFICACIÓN</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlPrimerChat" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button " class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>MENSAJE PRIVADO</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="form-group">
                    <textarea name="ChatPrimerMensaje" id="ChatPrimerMensaje" cols="30" rows="2" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md" onclick="enviarNotificacion()"><i class="fa fa-paper-plane fa-fw"></i>ENVIAR</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlChat" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md" style="height: 82%;">
        <div class="modal-content" style="width: 100%;height: 100%;">
            <div class="modal-header" style="background: black">
                <button type="button " class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong id="CliNom">CHAT</strong></h4>
            </div>
            <div class="modal-body" style="height: 80%;overflow-y:auto;padding:0px">
                <div class="container-chat chat" id="ChatContainer">
                    <div class="col-md-12 no_padding" id="ShowedChat">
                        <div class="cvs">
                            <ul style="padding-top: 10px;" id="ChatMensajes">

                            </ul>
                        </div>
                    </div>
                </div>
                <input id="RfId" name="RfId" type="hidden">
            </div>
            <div class="modal-footer" style="padding-top: 0px;">
                <div class="row">
                    <textarea name="ChatSms" id="ChatSms" cols="8" rows="2" class="form-control" maxlength="255" style="resize: none;"></textarea><br>
                    <button class="btn btn-md" onclick="enviarChatMensaje()"><i class="fa fa-paper-plane fa-fw"></i>ENVIAR</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlNuevaRutina" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button" class="close btn-white" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>ELEGIR TIPO DE RUTINA</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 450px; overflow-y: auto;">
                <div class="col col-md-12 text-center" id="NuevaRutianStep1">
                    <div class="col-md-6 col-sm-6 col-xs-6" style="margin-bottom: 10px;">
                        <h6>Standard</h6>
                        <img class="div-fichas" onclick="elegirFicha(2)" th:src="@{/img/form_standard.svg}+'?'+${version}" alt="" style="width: 64px">
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-6" style="margin-bottom: 10px;">
                        <h6>Running</h6>
                        <img class="div-fichas" onclick="elegirFicha(1)" th:src="@{/img/form_runner.png}+'?'+${version}" alt="" style="width: 64px">
                    </div>
                </div>
                <div class="col col-md-12 text-center hidden" id="NuevaRutianStep2">
                    <div class="col-md-6 col-sm-6 col-xs-6" style="margin-bottom: 10px;">
                        <button class="btn btn-white" onclick="
                        crearRutina()" style="color:#2f2a2a">Nueva rutina</button>
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-6" style="margin-bottom: 10px;">
                        <button class="btn btn-white" onclick="seleccionarRutinaPlantilla()" style="color:#2f2a2a">Rutina a partir de una plantilla</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END MODAL PARA RUTINAS DE TIPO GENERAL -->
<!-- END MODALS -->
<!-- END MAIN PANEL -->
<!-- PAGE FOOTER -->

<!-- END PAGE FOOTER -->
<!-- IMPORTS JAVASCRIPT -->
<th:block th:insert="html-commons/tr/js :: fg-js"></th:block>
<!-- OTRAS LIBRERIAS DISTINTAS AL TEMPLATE -->
<script th:src="@{/js/bootstrap-table.min.js}+'?'+${version}"></script>
<script th:src="@{/js/plugin/moment/moment.min.js}+'?'+${version}"></script>
<script th:src="@{/js/hashids.min.js}+'?'+${version}"></script>

<script th:inline="javascript">
    const fInitRutGen = document.getElementById('RutFechaInicio');
    const fFinRutGen = document.getElementById('RutFechaFinal');
    const tblRegistros = document.getElementById('tblRegistros');
    const mdlNota = document.getElementById('mdlNota');
    const body = document.querySelector('body');
    let redFitId = 0;
    let feNuevaRutina = 0;
    let users = [];
    let $mnEle;

    let $table = $('#tblRegistros');
    let $index = $('#Id');
    let objForRutina = {};
    const modalPlantillas = document.querySelector('#myModalPlantillas');
    $countSinPlan = 0;
    $countPendientesEnvio = 0;

    $(function () {
        listarRegistros();
        init();
        fInitRutGen.addEventListener('change', setTotalSemanas);
        fFinRutGen.addEventListener('change', setTotalSemanas);
        modalPlantillas.addEventListener('click', eventosClickModalPlantillas);
        tblRegistros.addEventListener('click', clickListenerTbl);
        body.addEventListener('click',(e)=>{
            if(e.target.classList.contains('botTempo')){
                e.target.setAttribute('disabled', 'disabled');
            }
        });
        body.addEventListener('focusout', bodyFocusOutEventListener);
        document.querySelector('body').addEventListener('change', bodyChangeEventListener);


        $("#btnNuevo").click(function () {
            irRegistro();
        });

        $("#btnFiltrar").click(function () {
            listarRegistros();
        });

        $('#frm_busqueda').submit(function (e) {
            e.preventDefault();
        });

    });

    function bodyFocusOutEventListener(e){
        const input = e.target;
        if(input.tagName === "INPUT"){
            if(input.type==="text") {
                input.value = input.value.trim().replace(/ +/g, " ");
            }
        }

        if(input.tagName === "TEXTAREA"){
            input.value = input.value.trim();
        }
    }

    function bodyChangeEventListener(e) {
        const input = e.target;

        if (input.tagName === "INPUT") {
            if (input.type === "date") {
                if ($(input).valid()) {
                    if (input.nextElementSibling && input.nextElementSibling.tagName === "EM") {
                        input.nextElementSibling.remove();
                    }
                }
            }
        }
    }

    function preTemporadaCliente(cliId){

        $.ajax({
            type: 'GET',
            url: _ctx+'gestion/trainer/consolidado-cliente/obtener?cliId='+cliId,
            blockLoading: true,
            success: (r)=>{
                  window.location.href = _ctx + "cliente/rutina/consolidado/ver?key="+r;
            },
            error: (xhr)=>{
                exception(xhr)
            },
            complete: ()=>{

            }
        });
    }

    function preNotificacionPersonal(rfId, cliId, cliCorreo){
        $.ajax({
            type: 'GET',
            url: _ctx+'gestion/chat/get/'+rfId,
            blockLoading: true,
            dataType: 'json',
            success: (res)=>{
                reconstruirChat(res);
                $('#RfId').val(rfId);
                $('#CliNom').text(users.find(c => c.id == rfId).cliNombreCompleto);
                $('#InpCliId').val(cliId);
            },
            error: ()=>{
                //Cuando no se tiene ningún chat, el response será un 404, se setea esos datos para que en caso se envie el primer chat
                //se sepa a quien se va a notificar
                $('#mdlPrimerChat').modal('show');
                $('#InpCliId').val(cliId);
                $('#RfId').val(rfId);
                $('#InpCliCorreo').val(cliCorreo);
                document.querySelector('#InpTipoNotificacion').value = TipoNotificacion.PERSONAL;
            },
            complete: ()=>{

            }
        });
    }

    function enviarChatMensaje(){
        const fpTrainer = getCookie("GLL_IMG_PERFIL");
        const rfId = Number($('#RfId').val());
        const msj = $('#ChatSms').val().replace(/\r?\n/g, '<br />').trim();
        const dvChat = document.querySelector('#ChatContainer');
        const cliId = $('#InpCliId').val();
        if (!(msj.length > 0 && msj.length <= 255)) {
            $('#ChatSms').focus();
            $.smallBox({color: 'alert',
                content: '<i class="fa fa-exclamation-triangle fa-fw"></i>No puede enviar mensajes vacíos, además su mensaje no debe exceder los 255 caracteres'});
            return;
        }
        $.ajax({
            type: 'PUT',
            url: _ctx + 'gestion/chat/update/' + rfId,
            blockLoading: false,
            dataType: 'json',
            data: {
                msg: msj,
                cliId: cliId
            },
            success: (data) => {
                const esContinuo = data.esContinuo;
                const esSalida = data.esSalida;
                const htmlChats = document.querySelector('.cvs ul');
                htmlChats.appendChild(htmlStringToElement(`
                    <li class="sent ${esContinuo && !esSalida ? 'continuo':''}">
                        <div class="perfil">
                            <img src="https://s3-us-west-2.amazonaws.com/rf-profile-imgs/trainer/${fpTrainer}" />
                        </div>
                        <div class="messages message-sent">
                            <p class="name">${setFechaChat(getDateAsDateTimeString())}</p>
                            <div class="message">${msj}</div>
                        </div>
                    </li>
                `));

                //MainChat
                $('#ChatSms').val("");
                const chatBody = dvChat.parentElement;
                chatBody.scrollTop = chatBody.scrollHeight;
            },
            error: (err) => {
                exception(err)
            },
            complete: () => {
            }
        })
    }

    function reconstruirChat(chat){
        instanceMensajesChat(chat);
        $('#mdlChat').modal('show');
    }

    function preNotificacionGeneral(){
        $('#mdlCorreoGeneral').modal('show');
        document.querySelector('#CPAsunto').value = "";
        document.querySelector('#CPCuerpo').value = "";
        document.querySelector('#InpTipoNotificacion').value = TipoNotificacion.GENERAL;
    }

    function enviarNotificacion(){
        const tipoNotificacion = Number(document.querySelector('#InpTipoNotificacion').value);
        const data = {};
        let urlDiff = '';
        if(tipoNotificacion === TipoNotificacion.PERSONAL){
            data.cliId = $('#InpCliId').val();
            data.cliCorreo = $('#InpCliCorreo').val();
            data.cuerpo = $('#ChatPrimerMensaje').val().trim();
            data.fpTrainer = getCookie("GLL_IMG_PERFIL");
            data.nomTrainer = getFullNameFromUser();
            data.redFitId = $('#RfId').val();
            urlDiff = 'personal';
        }

        //Se valida antes de proseguir con el envio de la notificación
        if(tipoNotificacion === TipoNotificacion.GENERAL){
            if(!$('#frm_notif_gen').valid()){
                return;
            }
            data.asunto = $('#CPAsunto').val();
            data.cuerpo = $('#CPCuerpo').val().replace(/\r?\n/g, '<br />').trim();
            urlDiff = 'general';
        }

        if(!data.cuerpo){
            $.smallBox({color: 'alert', content: '<i>No puede enviar un mensaje vacío</i>'})
            return;
        }

        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/trainer/red/enviar/correo/'+urlDiff,
            data: data,
            blockLoading: true,
            dataType: 'json',
            success: (res)=>{
                reqSuccess(res);
            },
            error: (err)=>{
                exception(err);
            },
            complete: ()=>{
                if(tipoNotificacion === TipoNotificacion.PERSONAL){
                    $('#mdlPrimerChat').modal('hide');
                } else {
                    $('#mdlCorreoGeneral').modal('hide');
                }
            }
        })
    }

    function clickListenerTbl(e){
        const input = e.target;
        const clases = input.classList;
        if(input.tagName.toUpperCase() === "PATH"){
            let nueIn = searchSvg(input);
            if(nueIn.classList.contains('ico-nota')){
                $(mdlNota).modal('show');
                const nota = mdlNota.querySelector('textarea');
                nota.value = nueIn.getAttribute('data-full-content');
                nota.setAttribute('data-redfit-id', nueIn.getAttribute('data-redfit-id'));
            }
        }
        if(clases.contains('ico-nota')){
            $mnEle = input;
            $(mdlNota).modal('show');
            const nota = mdlNota.querySelector('textarea');
            nota.value = input.getAttribute('data-full-content');
            nota.setAttribute('data-redfit-id', input.getAttribute('data-redfit-id'));
        }

        if(clases.contains('rt-cli-ant')){

        }
    }

    function searchSvg(path){
        let svg = path;
        while(svg.tagName.toUpperCase() !== "SVG"){
            svg = svg.parentElement;
        }
        return svg;
    }

    function init(){
        const dt = new Date();

        let dateToString = d => `${d.getFullYear()}-${('00' + (d.getMonth() + 1)).slice(-2)}-${('00' + d.getDate()).slice(-2)}`;
        $('#RutFechaInicio').val(dateToString(dt));
        $('#RutFechaFinal').val(dateToString(dt));
        modalEventos();
        constraintsValidation();
        tblRegistros.classList.remove("table-hover"); // quita evento hover de tabla
    }

    function modalEventos(){
        $('#mdlChat').on('show.bs.modal', ()=> {
            setTimeout(() => {
                const chatBody = document.getElementById('ChatContainer').parentElement;
                chatBody.scrollTop = chatBody.scrollHeight;
                document.getElementById('ChatSms').focus();
            }, 250);
        })

        $('#mdlNuevaRutina').on('show.bs.modal', ()=> {
            $('#NuevaRutianStep1').removeClass('hidden');
            $('#NuevaRutianStep2').addClass('hidden');
        })

    }

    function setTotalSemanas(){
        const fechaInicio = parseFromStringToDate(fInitRutGen.value);
        const fechaFin = parseFromStringToDate(fFinRutGen.value);
        const totDias = moment(fechaFin).diff(fechaInicio, 'days') + 1;
        const diasPrimeraSemana = fechaInicio.getDay() == 0 ? 1 : 7 - fechaInicio.getDay() + 1;
        const totalSem = diasPrimeraSemana == 7 ? Math.floor(totDias / 7) : 1 + Math.ceil((totDias - diasPrimeraSemana) / 7);
        document.querySelector('#MacroTotalSemanas').textContent = isNaN(totalSem)? 0 : totalSem;
    }

    function actualizarNota(){
        const eleNota = mdlNota.querySelector('textarea');
        const nota = eleNota.value;
        const id = Number(eleNota.getAttribute('data-redfit-id'));
        let params = {
            id: id,
            nota: nota
        };
        $.ajax({
            type: 'PUT',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/trainer/red/anadir-nota',
            data: params,
            dataType: 'json',
            success: (d)=>{
                $.smallBox({content: 'Actualización exitosa'});
            },error: (xhr)=>{
                exception(xhr);
            }
            ,complete: ()=>{
                listarRegistros();
                $(mdlNota).modal('hide');
            }
        })
    }

    function listarRegistros() {

        if ($("#frm_busqueda").valid()) {
            const data = getFormData($("#frm_busqueda"));
            $table.bootstrapTable('destroy');
            $table.bootstrapTable({
                url: _ctx + 'gestion/trainer/red/obtenerListado',
                pagination: true,
                sidePagination: 'server',
                pageSize: 10,
                queryParams: (res)=> {
                    res.nombres = data.nombres;
                    return res;
                },
                onLoadSuccess: d => {

                    users = d.rows;
                    //Activando los popover y tooltips
                    users.forEach(r=>{
                        r.estadoPlan == 1 ? ++$countSinPlan : '';
                        r.estadoPlan == 2 ? ++$countPendientesEnvio : '';
                    })
                    $('[data-toggle="popover"]').popover();
                    $('[rel="tooltip"]').tooltip();
                    $('.total-pe').text($countPendientesEnvio);
                    $('.total-pp').text($countSinPlan);
                    instanceSvgAndPopovers();
                    tblRegistros.classList.remove("table-hover"); // quita evento hover de tabla

                },
                onLoadError: function (xhr) {
                    exception(xhr);
                },
            });
        }
    }

    function actualizarFlag(rfId){
        $.SmartMessageBox({
            title: '<i class="fa fa-exclamation-triangle" style="color: yellow"></i> RUNFIT',
            content: "" +
                "<br/><h6>Confirmar baja de atleta:</h6>",
            buttons: '[NO][SI]'
        }, function (ButtonPressed) {
            if (ButtonPressed === "SI") {
                setTimeout(() => {
                    $.ajax({
                        type: 'PUT',
                        url: _ctx + 'gestion/trainer/red/actualizar/flag',
                        blockLoading: false,
                        dataType: 'json',
                        data: {id: rfId},
                        success: () => {
                            $.smallBox({content: 'Actualización satisfactoria'});
                        },
                        error: (err) => {
                            exception(err);
                        },
                        complete: () => {
                            listarRegistros();
                        }
                    })
                }, 300);
            }
        });

    }

    function noCuentaConPrograma(){
        $.smallBox({color: "info", content: "<i>El atleta aún no cuenta con ninguna rutina asignada...</i>"})
    }

    function linkFormatter(value, row) {
        if(row.contadorRutinas == 0){
            return String('<a style="text-decoration: none;" href="#" onclick="javascript:noCuentaConPrograma()" title="El atleta aún no cuenta con ninguna rutina asignada" rel="tooltip">' + row.cliNombreCompleto + '</a>', value);
        }else{
            return String('<a style="text-decoration: none;" href="#" onclick="javascript:verUltimoPrograma(' + row.id +','+ row.cliId +',\''+ btoa(row.cliFechaNacimiento) +'\',\''+ btoa(row.cliNombreCompleto) + '\')" title="↗️ Ir al último programa" rel="tooltip">' + row.cliNombreCompleto + '</a>', value);
        }
    }

    function fttDesactivar(value, row){
        return `<img class="ico-upd-flag" rel="tooltip" title="Remover atleta del listado" onclick="actualizarFlag(${Number(value)})" src="${_ctx}img/trash.png"/>`;
    }

    function fttNota(v, row, ix){
        let opciones = '';
        const originalNota = row.nota ? row.nota : "";
        let nota = row.nota == null?"":row.nota.length>100 ? row.nota.substr(0,100).trim()+"..." : row.nota;
        if(nota == ""){
            opciones = `<img data-redfit-id="${row.id}" style="fill:#9d9d9d !important;" data-placement="top" data-toggle="popover" data-content="${nota}" data-full-content="${originalNota}" data-trigger="hover" class="svg ico-nota" id="svg${ix}" data-ix="${ix}" src="${_ctx}img/iconos/icon_edit.svg"/>`;
        }else{
            opciones = `<img data-redfit-id="${row.id}" data-placement="top" data-toggle="popover" data-content="${nota}" data-full-content="${originalNota}" data-trigger="hover" class="svg ico-nota" id="svg${ix}" data-ix="${ix}" src="${_ctx}img/iconos/icon_leyenda.svg"/>`;
        }
        return opciones;
    }

    function fttNp(v, row, ix, pos){
          return `<img class="svg rt-cli-ant" onclick="abrirOpcionesNuevaRutina(${row.id})" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_edit_file.svg"/>`;
    }

    function abrirOpcionesNuevaRutina(rfId){
        redFitId = rfId;
        $('#mdlNuevaRutina').modal('show');
    }

    function fttPlantillas(v, row, ix){
        var opciones = "";
        switch(row.estadoPlan) {
            case EstadoPlan.SIN_PLAN:
                let fnNuevoRutina = "crearPrimeraRutina";
                if(row.predeterminadaFichaId == TipoFicha.GENERAL){
                    objForRutina.redFitId = row.id;
                    objForRutina.cliId = row.cliId;
                    objForRutina.ix = ix;
                    objForRutina.contadorRutinas = row.contadorRutinas;
                    fnNuevoRutina = "abrirModalRutinaGen";
                }
                opciones += `<img class="svg"
                                title="Crear rutina" rel="tooltip"
                                onclick='javascript:${fnNuevoRutina}(${row.id},${row.cliId}, ${row.contadorRutinas}, ${"\"" + btoa(row.cliFechaNacimiento) + "\""}, ${"\"" + btoa(row.cliNombreCompleto) + "\""});'
                                src="${_ctx}img/iconos/iconos_RunFit_entrena copia 10.svg"/>`
                break;
            case EstadoPlan.EN_REVISION:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_entrena copia 10.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            case EstadoPlan.POR_ENVIAR:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_entrena copia 10.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            case EstadoPlan.INICIADO:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_entrena copia 10.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            default://EstadoPlan.CULMINADO
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_entrena copia 10.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
        }
        return opciones;
    }
    function fttMeses(v, row, ix) {

        if (row.contadorRutinas == 0) {
            return `<img class="svg" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_archivo.svg"/>`;
        } else {
            return `<img class="svg" data-redfit-id="${row.id}"  onClick="javascript:verHistorialRutina('${row.id}','${row.cliId}','${btoa(row.cliNombreCompleto)}','${btoa(row.cliFechaNacimiento)}')" src="${_ctx}img/iconos/icon_archivo.svg"/>`;
        }
    }


    function fttTemporada(v, row, ix){
        return `<img class="svg" onclick="preTemporadaCliente(${row.cliId})" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_disquete.svg"/>`;
    }
    function fttEnviarCorreo(v, row, ix){
        return `<img class="svg" onclick="preNotificacionPersonal(${row.id}, ${row.cliId}, '${row.cliCorreo}')" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_mail.svg"/>`;
    }

    function instanceSvgAndPopovers(){
        $('#tblRegistros img.svg').each(function () {
            var $img = jQuery(this);
            var imgURL = $img.attr('src');
            var element = $img[0];

            $.get(imgURL, function (data) {
                var $svg = $(data).find('svg');
                Array.from(element.attributes).forEach(e=>{
                    $svg.attr(e.nodeName, e.nodeValue);
                });
                $svg.removeAttr('xmlns:a');
                if (!$svg.attr('viewBox') && $svg.attr('height') && $svg.attr('width')) {
                    $svg.attr('viewBox', '0 0 ' + $svg.attr('height') + ' ' + $svg.attr('width'));
                }
                $img.replaceWith($svg);
                if($svg[0].hasAttribute('rel')){
                    $($svg[0]).tooltip();
                }
                if($svg[0].classList.contains('ico-nota')){
                    $($svg[0]).popover();
                }

            }, 'xml');

        });
    }

    function elegirFicha(tipoFicha){
        feNuevaRutina = tipoFicha;
        $('#NuevaRutianStep2').removeClass('hidden');
        $('#NuevaRutianStep1').addClass('hidden');
    }

    function Opciones(value, row, index) {
        let opciones = '';

        switch(row.estadoPlan) {

            case EstadoPlan.SIN_PLAN:
                let fnNuevoRutina = "crearPrimeraRutina";
                if(row.predeterminadaFichaId == TipoFicha.GENERAL){
                    objForRutina.redFitId = row.id;
                    objForRutina.cliId = row.cliId;
                    objForRutina.ix = index;
                    objForRutina.contadorRutinas = row.contadorRutinas;
                    fnNuevoRutina = "abrirModalRutinaGen";
                }
                opciones += `<a data-toggle="modal" data-target="#myModalPlantillas"  onclick='javascript:asignarPlantilla(${row.id}, ${row.cliId},"${row.cliCorreo}",${index});' title='Asignar Rutina'><i class='fa fa-file-text fa-2x'></i></a> &nbsp &nbsp
                             <a href='#' onclick='javascript:${fnNuevoRutina}(${row.id},${row.cliId},${index}, ${row.contadorRutinas}, ${"\""+btoa(row.cliFechaNacimiento)+"\""}, ${"\""+btoa(row.cliNombreCompleto)+"\""});' title='Crear Rutina'><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`

                break;
            case EstadoPlan.EN_REVISION:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            case EstadoPlan.POR_ENVIAR:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            case EstadoPlan.INICIADO:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            default://EstadoPlan.CULMINADO
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
        }
        opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="La revisión de la rutina aún no ha sido aprobada" rel="tooltip"><i class="fa fa-send-o fa-2x"></i></a> &nbsp &nbsp`;
        opciones +=`<a href='#' onclick='javascript:crearPrimeraRutina(${row.id},${row.cliId}, ${row.contadorRutinas}, ${"\""+btoa(row.cliFechaNacimiento)+"\""}, ${"\""+btoa(row.cliNombreCompleto)+"\""});' title='Crear Rutina'><i class='fa fa-check fa-2x'></i></a>`;
        return opciones;
    }

    function abrirModalRutinaGen(){
        $('#myModalRutGen').modal('show');
    }

    function crearPrimeraRutinaGeneral(input){
        input.setAttribute('disabled', 'disabled');
        if(!$('#frm_nue_rut_gen').valid()){
            input.removeAttribute('disabled');
            return;
        }
        const rutina = getBasicosNueRutGen();
        rutina.redFitnessId = typeof objForRutina.redFitId === 'undefined' ? objForRutina.id : objForRutina.redFitId;
        rutina.clienteId = objForRutina.cliId;
        rutina.control = {};
        rutina.control.avanceSemanas = new Array(rutina.totalSemanas).fill("");

        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: _ctx + "gestion/rutina/nueva/general",
            dataType: "json",
            blockLoading: true,
            noOne: false,
            data: JSON.stringify(rutina),
            success: function (data) {
                const id = data.res;
                const rn = data.rdm;
                window.location.href = _ctx + 'rutina/editor?key=' + id + '&rn=' + rn;//res.id para el caso = redFitnessId;
            },
            error: function (xhr) {
                input.removeAttribute('disabled');
                exception(xhr);
            },
            complete: function () {

            }
        });
    }

    function getBasicosNueRutGen(){
        const $chelmoMacro = [];
        const totalSemanas = $('#MacroTotalSemanas').text().trim();
        //Semanas
        const fIni = parseFromStringToDate(document.querySelector('#RutFechaInicio').value);
        let fFin = parseFromStringToDate(document.querySelector('#RutFechaFinal').value);
        if(fIni.getTime() >= fFin.getTime()){
            $.smallBox({
                color: "alert",
                content: "<i>La fecha de inicio no puede ser mayor o igual a la del final</i>"});
            return;
        }
        for(let i=0; i<totalSemanas;i++){
            const refDia = fIni.getDay();
            let diasParaFull = refDia==0?0:7-refDia;
            if(i == 0){
                const objFirtsWeek = {};
                objFirtsWeek.fechaInicio = moment(fIni).add((i*7), 'd').format('DD/MM/YYYY');
                objFirtsWeek.fechaFin = moment(fIni).add((i*7)+diasParaFull, 'd').format('DD/MM/YYYY');
                objFirtsWeek.flagFull = refDia == 1 ? true : false;
                const literales = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];//Artificio temporal(2 domingos)
                const dias = [];
                for(let i=0; i<diasParaFull+1; i++){
                    const fechaParse = parseFromStringToDate2(moment(fIni).add((i), 'd').format('DD/MM/YYYY'));
                    dias.push({fecha: moment(fIni).add((i), 'd').format('DD/MM/YYYY'), dia: fechaParse.getDate(), flagDescanso: false, literal: literales[fechaParse.getDay()], diaLiteral: fechaParse.getDate() + " "+ literales[fechaParse.getDay()]});
                }
                objFirtsWeek.lstDia = dias;
                $chelmoMacro.push(new Semana(objFirtsWeek))
            } else{
                $chelmoMacro.push(new Semana(undefined, parseFromStringToDate(moment($chelmoMacro[i-1].fechaFin).add(1, 'd').format('YYYY-MM-DD')),parseFromStringToDate(moment($chelmoMacro[i-1].fechaFin).add(7, 'd').format('YYYY-MM-DD'))));
            }
        }

        //Modificando fecha fin de la ultima semana en caso esta no se encuentre mapeada con los 7 días calendarios
        $chelmoMacro[totalSemanas-1].fechaFin = fFin;
        //Rutina
        const r = {};
        r.fechaInicio = fIni;
        r.fechaFin = fFin;
        r.dias = moment(fFin).diff(fIni, 'days') + 1;
        r.meses = Math.floor(r.dias/30);
        r.anios = Math.floor(r.meses/12);
        r.totalSemanas = Number(totalSemanas);
        r.semanas = $chelmoMacro;
        return r;
    }

    function crearPrimeraRutina(id, clienteId, contadorRutinas, fechaNac, cliFullNombre){
        const datosAsURI = '&fn=' + fechaNac + '&nm=' + cliFullNombre;
        id = getHash32Id('rf-rutina', id);
        clienteId = getHash16Id('rf-rutina', clienteId);
        $.SmartMessageBox({
            title: '<i class="fa fa-exclamation-triangle" style="color: yellow"></i> RUNFIT',
            content: "" +
                "<br/><h6>Confirmar:</h6>",
            buttons: '[NO][SI]'
        }, function (ButtonPressed) {
            if (ButtonPressed === "SI") {
               window.location.href = _ctx+'rutina/pre?key='+id + '&rn='+clienteId + datosAsURI;//res.id para el caso = redFitnessId;
            }
        });

        setFechaActual(document.querySelectorAll('input[type="date"]'));

    }

    function verUltimoPrograma(redFitnessId, clienteId, fechaNac, cliFullNombre){

       const datosAsURI = '&fn=' + fechaNac + '&nm=' + cliFullNombre;
       window.location.href = _ctx+'rutina/editor?key='+ getHash32Id('rf-rutina', redFitnessId) + '&rn='+ getHash16Id('rf-rutina', clienteId)+datosAsURI;
    }


    function verHistorialRutina(redFitnessId, clienteId, nombreCompleto,fechaNacimiento){
       window.location.href = _ctx+'gestion/trainer/red/historial_rutina?key='+ getHash32Id('rf-rutina', redFitnessId) + '&rn='+ getHash16Id('rf-rutina', clienteId) +'&nm=' + nombreCompleto + '&fn='+fechaNacimiento;
    }

    function estadoPlan(value, row){
        let icon = '';
        switch(row.estadoPlan){
            case EstadoPlan.SIN_PLAN:
                icon = `<span href="#" class="label label-danger"><i class="fa fa-warning fa-fw"></i> Sin Plan</span>`;
                break;
            case EstadoPlan.EN_REVISION:
                icon = `<span href="#" class="label label-info"><i class="fa fa-dot-circle-o fa-fw"></i> En Revisión</span>`;
                break;
            case EstadoPlan.POR_ENVIAR:
                icon = `<span href="#" class="label label-warning"><i class="fa fa-send fa-fw"></i> Pendiente de Envío</span>`;
                break;
            case EstadoPlan.INICIADO:
                icon = `<span href="#" class="label label-default bg-color-orange"><i class="fa fa-bolt fa-fw"></i> Plan Iniciado</span>`;
                break;
            default://EstadoPlan.COLMINADO
                icon = `<span href="#" class="label label-success"><i class="fa fa-check fa-fw"></i> Plan Finalizado</span>`;
                break;
        }
        return icon;
    }

    function formatterFechaInicialPlanificacion(value){
        if(value != undefined){
            return value;
        }
        return "-";
    }

    function formatterFechaFinalPlanificacion(value){
        if(value != undefined){
            let fecha = parseFromStringToDate2(value);
            let diasParaUltimaFecha = moment(fecha).diff(new Date(), 'days');
            if(diasParaUltimaFecha <8){
                return `<span href="#" class="label txt-color-red">${value}</span>`
            }else if(diasParaUltimaFecha <15){
                return `<span href="#" class="label txt-color-orangeDark">${value}</span>`
            }else{
                return `<span href="#" class="label txt-color-greenLight">${value}</span>`
            }
        }
        return "-";
    }

    function asignarPlantilla(redId, clienteId, correo , index){

        let plantillas = document.querySelector('#Plantillas');
        document.querySelector('#spRaw3').innerHTML = spinnerHTMLRawCsMessage('Cargando...');
        let params = {};
        params.clienteId = clienteId;
        params.redFitnessId = redId;
        $('#CorreoCliente').text(correo);
        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx + 'gestion/rutina-plantilla/trainer/red/obtenerListado',
            dataType: 'json',
            data: params,
            success: function(data){
                if(data.length>0){
                    let htmlRaw = '';
                    data.forEach((plantilla,i)=>{
                        htmlRaw += `    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                            <div class="row" style="border-radius: 5%;margin:5px;background: #cae6b9 !important;">
                                                <a href="#" onclick="javascript:elegirPlantillaParaCliente(${plantilla.id}, ${index});" class="elegir-plantilla" data-plantilla-id="${plantilla.id}" >
                                                    <h6 class="text-align-center bg-color-lighten txt-color-orangeDark">${i+1}</h6>
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" >
                                                        <h6>Años: </h6>
                                                        <h6>Meses: </h6>
                                                        <h6>Semanas: </h6>
                                                        <h6>Dias: </h6>
                                                    </div>
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                                        <h6 class="text-align-center">${plantilla.anios} </h6>
                                                        <h6 class="text-align-center">${plantilla.meses} </h6>
                                                        <h6 class="text-align-center">${plantilla.totalSemanas} </h6>
                                                        <h6 class="text-align-center">${plantilla.dias}  </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </div>`
                    });

                    plantillas.innerHTML = htmlRaw;
                }else{
                    plantillas.innerHTML = '<h6 class="text-align-center"><b>No se encontraron plantillas registradas...</b></h6>'
                }
            },
            error: function(xhr){
            },
            complete: function(){

            }
        })
    }

    function elegirPlantillaParaCliente(rutinaPlantillaId, ix){
        document.querySelector('#myModalPlantillas #Plantillas').innerHTML = spinnerHTMLRawCsMessage('Notificando a cliente... Espere por favor...');
        //ix: Nos servira para actualizar en el dom el flagEnActividad
        var actualStatus = document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').textContent;
        let params = {};
        params.rutinaPlantillaId = rutinaPlantillaId;
        params.correo = document.querySelector('#CorreoCliente').textContent.trim();

        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx + 'gestion/rutina/agregar',
            dataType: 'json',
            data: params,
            success: function(){
                $.smallBox({content: '<i>Se le ha asignado exitosamente la rutina al cliente...</i>'});
                actualStatus == "Activo" ?
                    document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').innerHTML = '<span class="label label-success">Activo</span>'
                    :
                    document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').innerHTML= '<span class="label label-success">Activo</span>';
                //Removiendo la accion al boton de asignar
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('onclick');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('data-toggle');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('data-target');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].style.color="gray";
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].title="Ya se ha asignado una rutina al cliente";
                //2.
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].removeAttribute('onclick');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].style.color="gray";
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].title="Ya se ha asignado una rutina al cliente";
                $('#myModalPlantillas').modal('hide');
            },
            error: function(xhr){
            },
            complete: function(){
            }
        })
    }

    function eventosClickModalPlantillas(e){}//No implemetada

    function crearRutina(){
        if(feNuevaRutina == TipoFicha.RUNNING){
            const obj = users.find(u=>u.id==redFitId);
            crearPrimeraRutina(obj.id, obj.cliId, obj.contadorRutinas, btoa(obj.cliFechaNacimiento), btoa(obj.cliNombreCompleto));
        } else{
            $('#mdlNuevaRutina').modal('hide');
            $('#myModalRutGen').modal('show');
            objForRutina = users.find(u=>u.id==redFitId);
        }
    }

    let myExcelXML = (function() {
        let Workbook, WorkbookStart = '<?xml version="1.0"?><ss:Workbook  xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">';
        const WorkbookEnd = '</ss:Workbook>';
        let fs, SheetName = new Date().getTime(),
            styleID = 1, columnWidth = 80,
            fileName = "Listado_Atletas_"+new Date(), uri, link;

        class myExcelXML {
            constructor(o) {
                let respArray = o;
                let finalDataArray = [];

                for (let i = 0; i < respArray.length; i++) {
                    finalDataArray.push(flatten(respArray[i]));
                }

                let s = JSON.stringify(finalDataArray);
                fs = s.replace(/&/gi, '&amp;');
            }

            downLoad() {
                const Worksheet = myXMLWorkSheet(SheetName, fs);

                WorkbookStart += myXMLStyles(styleID);

                Workbook = WorkbookStart + Worksheet + WorkbookEnd;

                uri = 'data:text/xls;charset=utf-8,' + encodeURIComponent(Workbook);
                link = document.createElement("a");
                link.href = uri;
                link.style = "visibility:hidden";
                link.download = fileName + ".xls";

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            get fileName() {
                return fileName;
            }

            set fileName(n) {
                fileName = n;
            }

            get SheetName() {
                return SheetName;
            }

            set SheetName(n) {
                SheetName = n;
            }

            get styleID() {
                return styleID;
            }

            set styleID(n) {
                styleID = n;
            }
        }

        const myXMLStyles = function(id) {
            let Styles = '<ss:Styles><ss:Style ss:ID="' + id + '"><ss:Font ss:Bold="1"/></ss:Style></ss:Styles>';

            return Styles;
        };

        const myXMLWorkSheet = function(name, o) {
            const Table = myXMLTable(o);
            let WorksheetStart = '<ss:Worksheet ss:Name="' + name + '">';
            const WorksheetEnd = '</ss:Worksheet>';

            return WorksheetStart + Table + WorksheetEnd;
        };

        const myXMLTable = function(o) {
            let TableStart = '<ss:Table>';
            const TableEnd = '</ss:Table>';

            const tableData = JSON.parse(o);

            if (tableData.length > 0) {
                const columnHeader = Object.keys(tableData[0]);
                let rowData;
                for (let i = 0; i < columnHeader.length; i++) {
                    TableStart += myXMLColumn(columnWidth);

                }
                for (let j = 0; j < tableData.length; j++) {
                    rowData += myXMLRow(tableData[j], columnHeader);
                }
                TableStart += myXMLHead(1, columnHeader);
                TableStart += rowData;
            }
            return TableStart + TableEnd;
        };

        const myXMLColumn = function(w) {
            return '<ss:Column ss:AutoFitWidth="0" ss:Width="' + w + '"/>';
        };


        const myXMLHead = function(id, h) {
            let HeadStart = '<ss:Row ss:StyleID="' + id + '">';
            const HeadEnd = '</ss:Row>';

            for (let i = 0; i < h.length; i++) {
                const Cell = myXMLCell(h[i].toUpperCase());
                HeadStart += Cell;
            }

            return HeadStart + HeadEnd;
        };

        const myXMLRow = function(r, h) {
            let RowStart = '<ss:Row>';
            const RowEnd = '</ss:Row>';
            for (let i = 0; i < h.length; i++) {
                const Cell = myXMLCell(r[h[i]]);
                RowStart += Cell;
            }

            return RowStart + RowEnd;
        };

        const myXMLCell = function(n) {
            let CellStart = '<ss:Cell>';
            const CellEnd = '</ss:Cell>';

            const Data = myXMLData(n);
            CellStart += Data;

            return CellStart + CellEnd;
        };

        const myXMLData = function(d) {
            let DataStart = '<ss:Data ss:Type="String">';
            const DataEnd = '</ss:Data>';

            return DataStart + d + DataEnd;
        };

        const flatten = function(obj) {
            var obj1 = JSON.parse(JSON.stringify(obj));
            const obj2 = JSON.parse(JSON.stringify(obj));
            if (typeof obj === 'object') {
                for (var k1 in obj2) {
                    if (obj2.hasOwnProperty(k1)) {
                        if (typeof obj2[k1] === 'object' && obj2[k1] !== null) {
                            delete obj1[k1];
                            for (var k2 in obj2[k1]) {
                                if (obj2[k1].hasOwnProperty(k2)) {
                                    obj1[k1 + '-' + k2] = obj2[k1][k2];
                                }
                            }
                        }
                    }
                }
                var hasObject = false;
                for (var key in obj1) {
                    if (obj1.hasOwnProperty(key)) {
                        if (typeof obj1[key] === 'object' && obj1[key] !== null) {
                            hasObject = true;
                        }
                    }
                }
                if (hasObject) {
                    return flatten(obj1);
                } else {
                    return obj1;
                }
            } else {
                return obj1;
            }
        };
        return myExcelXML;
    })();

    function exportarListadoAExcel(){
        new myExcelXML(users).downLoad();
    }

    function constraintsValidation(){

        let nowDatePlusOne = new Date();
        nowDatePlusOne.setDate(nowDatePlusOne.getDate()+1);
        nowDatePlusOne = parseFromStringToDate(getFechaFormatoString(nowDatePlusOne));
        let miniumPlusDaysForValidRoutine = 7*6//6 Semanas mínimo

        $('#frm_notif_gen').validate({
            rules:{
                CPAsunto: {
                    required: true,
                    rangelength: [5, 100],
                    letterandnumber: true
                },
                CPCuerpo: {
                    required: true,
                    rangelength: [5, 2000],
                }
            },
            messages:{

            }
        });

        $('#frm_nue_rut_gen').validate({
            rules:{
                RutFechaInicio: {
                    greaterThanDate: nowDatePlusOne,
                    isSpecificDay : 1
                },
                RutFechaFinal: {
                    minimumDifference: function(){
                        return  $('#RutFechaInicio').val()
                    },
                    maximumDifference: function(){
                        return  $('#RutFechaInicio').val()
                    },
                    greaterThanDate: function(){
                        const final = parseFromStringToDate($('#RutFechaInicio').val());
                        final.setDate(final.getDate()+(miniumPlusDaysForValidRoutine-1));
                        return parseFromStringToDate(getFechaFormatoString(final));
                    },
                    isSpecificDay : 0
                }
            },
            messages:{

            }
        })


    }


    function seleccionarRutinaPlantilla(){

        const obj = users.find(u=>u.id==redFitId);
        const id = getHash32Id('rf-rutina', obj.id);
        const clienteId = getHash16Id('rf-rutina', obj.cliId);

        window.location.href = _ctx + 'planes/seleccion?key=' + id + '&rn=' + clienteId +  '&tr='+feNuevaRutina
    }

    function instanceMensajesChat(chat){
        const fpTrainer = getCookie("GLL_IMG_PERFIL");

        const bodyChats = document.getElementById('ChatMensajes');
        const mensajes = chat.mensajes;
        bodyChats.innerHTML = "";
        mensajes.forEach(c=>{
            bodyChats.appendChild(htmlStringToElement(
                        `<li class="${!c.esSalida ? 'sent':'received'} ${c.esContinuo ? 'continuo' : ''}">
                            <div class="perfil">
                                ${c.esSalida ?
                                    `<img class="user" src="${_ctx}img/user_avatar.png">`:
                                    `<img class="user" src="https://s3-us-west-2.amazonaws.com/rf-profile-imgs/trainer/${fpTrainer}">`}
                            </div>
                            <div class="messages ${!c.esSalida ? 'message-sent':'message-received'}">
                                <p class="name">${c.esSalida ? chat.nomTrainer : ''} <span>${setFechaChat(c.fecha)}</span></p>
                                <div class="message">${c.msg}</div>
                            </div>
                        </li>`))
        })

    }
</script>

</body>

</html>

<!DOCTYPE html>
<html lang="en-us"
	  xmlns:th="http://www.thymeleaf.org"
	  th:with="version = ${#servletContext.getAttribute('version')}">
<head>
    <title>Mis clientes</title>
    <th:block th:insert="html-commons/in/meta :: fg-meta"></th:block>
    <th:block th:insert="html-commons/in/css  :: fg-css"></th:block>
    <link rel="stylesheet" type="text/css" th:href="@{/css/trainer.css}+'?'+${version}">
</head>
<style>
    .elegir-plantilla h6 {
        font-size: 11px;
    }

    .elegir-plantilla:hover {
        background: #feff8c !important;
    }

    .br-sp {
        border-radius: 60% !important;
        padding: 4px;
    }

    .sidebar li.active a {
        color: #a8fa00;

    }
    .sidebar li.active svg {
        fill: #a8fa00;
    }

    #tblRegistros svg:hover {
        cursor: pointer;
    }

    tbody svg {
        fill: #daffc6 !important;
    }

</style>
<body>
<th:block th:insert="html-commons/in/left-panel::fg-menu-desk"></th:block>
<th:block th:insert="html-commons/in/left-panel::fg-menu-mob"></th:block>

<!-- MAIN PANEL -->
<div id="main-content" role="main">
    <!-- MAIN CONTENT -->
    <div id="wrapper">
        <header>
            <ul class="nav nav-pills">
                <li class="active col-md-2"><a href="#">LISTADO</a></li>
                <li class="col-md-2"><a href="#">G. VIDEOS</a></li>
                <li class="col-md-3"><a href="#">RUTINARIO</a></li>
                <li class="col-md-2"><a href="#">G. AUDIOS</a></li>
                <li class="col-md-3"><a href="#">PLANES PREDISEÑADOS</a></li>
            </ul>
        </header>
        <div class="container-t">
            <div class="options">
                <img class="svg" onclick="preNotificacionGeneral()" th:src="@{/img/iconos/icon_chat.svg}+'?'+${version}">
                <img class="svg" th:src="@{/img/iconos/icon_candado.svg}+'?'+${version}">
            </div>
            <div class="" style="padding-bottom: 20px">
                <form id="frm_busqueda">
                    <div class="input-group">
                        <input class="form-control" type="text" id="Nombres" name="Nombres">
                        <div class="input-group-btn">
                            <button class="btn btn-default" type="submit" id="btnFiltrar">BUSCAR</button>
                        </div>
                    </div>
                </form>
            </div>
            <fieldset>
                <section>
                    <div class="row" id="view_list">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <table id="tblRegistros" data-mobile-responsive="true" class="table table-bordered table-condensed">
                                <thead>
                                <tr>
                                    <th data-formatter="fttNota" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="5%">Notas
                                    </th>
                                    <th data-formatter="formatterFechaInicialPlanificacion" data-field="fechaInicialPlanificacion" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="10%"><img class="svg" th:src="@{/img/iconos/icon_calendar.svg}+'?'+${version}">
                                    </th>
                                    <th data-formatter="formatterFechaFinalPlanificacion" data-field="fechaFinalPlanificacion" data-halign="center" data-valign="middle"
                                        data-align="center" data-width="10%"><img class="svg" th:src="@{/img/iconos/icon_calendar.svg}+'?'+${version}">
                                    </th>
                                    <th data-formatter="linkFormatter" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="25%">Nombre y apellidos
                                    </th>
                                    <th data-formatter="fttNp" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="5%">N.P
                                    </th>
                                    <th data-formatter="fttPlantillas" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="5%">Plantillas
                                    </th>
                                    <th data-formatter="fttMeses" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Meses
                                    </th>
                                    <th data-formatter="fttTemporada" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Temporada
                                    </th>
                                    <th data-formatter="fttEnviarCorreo" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Enviar Correo
                                    </th>
                                    <th data-field="cliMovil" data-halign="center" data-valign="middle" data-align="center"
                                        data-width="10%">Teléfono
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </section>
            </fieldset>
        </div>
    </div>
    <!-- END MAIN CONTENT -->
</div>
<!-- MODALS -->
<div class="modal fade" id="mdlNota" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button btn-white" class="close" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>Añada la nota</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="">
                    <textarea name="NotaCliente" id="NotaCliente" cols="30" rows="3" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md" onclick="actualizarNota()">GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>
</div>
<!-- MODAL MOSTRAR RUTINAS PLANTILLA -->
<div class="modal fade" id="myModalPlantillas" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header txt-color-white bg-color-teal">
                <button type="button" class="close" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>Mis Plantillas Rutina</strong></h4>
                <span id="CorreoCliente" hidden="hidden"></span>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div id="Plantillas" class="row">
                    <!-- CONTENIDO DE LA MINI PLANTILLA -->
                </div>
                <div id="spRaw3" class="form-group">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END MODAL CREAR MINI RUTINA -->
<!-- MODAL PARA RUTINAS DE TIPO GENERAL -->
<div class="modal fade" id="myModalRutGen" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header txt-color-white bg-color-teal">
                <button type="button" class="close" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>Generación de rutina</strong></h4>

            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="row">
                    <div class="col col-md-12">
                        <div class="col col-md-6">
                            <label for="RutFechaInicio">Fecha Inicio:</label>
                            <input id="RutFechaInicio" type="date" class="form-control">
                        </div>
                        <div class="col col-md-6">
                            <label for="RutFechaFinal">Fecha Inicio:</label>
                            <input id="RutFechaFinal" type="date" class="form-control">
                        </div>
                        <div style="" class="row text-center col-md-12 padding-top-10">Total semanas: <span id="MacroTotalSemanas">0</span></div>
                    </div>
                </div>
                <div id="spRaw4" class="form-group">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="crearNuevaRutinaGeneral()" class="btn btn-primary">CREAR RUTINA</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlCorreoPersonal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: black">
                <button type="button btn-white" class="close" data-dismiss="modal" title="Close"> <span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-align-center"><strong>NOTIFICAR</strong></h4>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="form-group">
                    <label class="">ASUNTO:</label>
                    <input name="CPAsunto" id="CPAsunto"class="form-control">
                </div>
                <div class="form-group">
                    <label class="">MENSAJE:</label>
                    <textarea name="CPCuerpo" id="CPCuerpo" cols="30" rows="8" class="form-control"></textarea>
                </div>
                <input type="number" id="InpTipoNotificacion" class="hidden">
                <input type="text" id="InpCliId" class="hidden">
                <input type="text" id="InpCliCorreo" class="hidden">
            </div>
            <div class="modal-footer">
                <button class="btn btn-md" onclick="enviarNotificacion()">ENVIAR NOTIFICACIÓN</button>
            </div>
        </div>
    </div>
</div>
<!-- END MODAL PARA RUTINAS DE TIPO GENERAL -->
<!-- END MODALS -->
<!-- END MAIN PANEL -->
<!-- PAGE FOOTER -->

<!-- END PAGE FOOTER -->
<!-- IMPORTS JAVASCRIPT -->
<th:block th:insert="html-commons/in/js :: fg-js"></th:block>
<!-- OTRAS LIBRERIAS DISTINTAS AL TEMPLATE -->
<script th:src="@{/js/bootstrap-table.min.js}+'?'+${version}"></script>
<script th:src="@{/js/plugin/moment/moment.min.js}+'?'+${version}"></script>
<script th:src="@{/js/hashids.min.js}+'?'+${version}"></script>
<script th:src="@{/js/rutina.js}+'?'+${version}"></script>

<script th:inline="javascript">
    const fInitRutGen = document.getElementById('RutFechaInicio');
    const fFinRutGen = document.getElementById('RutFechaFinal');
    const tblRegistros = document.getElementById('tblRegistros');
    const mdlNota = document.getElementById('mdlNota');
    let $mnEle;

    let $table = $('#tblRegistros');
    let $index = $('#Id');
    let $nota = '';
    let objForRutina = {};
    const modalPlantillas = document.querySelector('#myModalPlantillas');
    $countSinPlan = 0;
    $countPendientesEnvio = 0;

    $(function () {
        listarRegistros();
        init();

        fInitRutGen.addEventListener('change', setTotalSemanas);
        fFinRutGen.addEventListener('change', setTotalSemanas);
        modalPlantillas.addEventListener('click', eventosClickModalPlantillas);
        tblRegistros.addEventListener('click', clickListenerTbl);
        $table[0].addEventListener('focusout', eventosGeneralesFocusOut);

        $("#btnNuevo").click(function () {
            irRegistro();
        });

        $("#btnFiltrar").click(function () {
            listarRegistros();
        });

        $('#frm_busqueda').submit(function (e) {
            e.preventDefault();
        });

    });

    function preNotificacionPersonal(cliId, cliCorreo){
        $('#mdlCorreoPersonal').modal('show');
        $('#InpCliId').val(cliId);
        $('#InpCliCorreo').val(cliCorreo);
        document.querySelector('#InpTipoNotificacion').value = TipoNotificacion.PERSONAL;
    }

    function preNotificacionGeneral(){
        $('#mdlCorreoPersonal').modal('show');
        document.querySelector('#InpTipoNotificacion').value = TipoNotificacion.GENERAL;
    }

    function enviarNotificacion(){
        const tipoNotificacion = Number(document.querySelector('#InpTipoNotificacion').value);
        const data = {};
        let urlDiff = '';
        if(tipoNotificacion === TipoNotificacion.PERSONAL){
            data.cliId = $('#InpCliId').val();
            data.cliCorreo = $('#InpCliCorreo').val();
            data.asunto = $('#CPAsunto').val();
            data.cuerpo = $('#CPCuerpo').val();
            urlDiff = 'personal';
        }

        if(tipoNotificacion === TipoNotificacion.GENERAL){
            data.asunto = $('#CPAsunto').val();
            data.cuerpo = $('#CPCuerpo').val().replace(/\r?\n/g, '<br />');
            urlDiff = 'general';
        }

        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/trainer/red/enviar/correo/'+urlDiff,
            data: data,
            blockLoading: true,
            dataType: 'json',
            success: (res)=>{
                reqSuccess(res);
            },
            error: (err)=>{
                exception(err);
            },
            complete: ()=>{
                $('#mdlCorreoPersonal').modal('hide');
            }
        })
    }

    function clickListenerTbl(e){
        const input = e.target;
        const clases = input.classList;

        if(input.tagName.toUpperCase() === "PATH"){
            let nueIn = searchSvg(input);
            if(nueIn.classList.contains('ico-nota')){
                $(mdlNota).modal('show');
                const nota = mdlNota.querySelector('textarea');
                nota.value = nueIn.getAttribute('data-content');
                nota.setAttribute('data-redfit-id', nueIn.getAttribute('data-redfit-id'));
            }
        }
        if(clases.contains('ico-nota')){
            $mnEle = input;
            $(mdlNota).modal('show');
            const nota = mdlNota.querySelector('textarea');
            nota.value = input.getAttribute('data-content');
            nota.setAttribute('data-redfit-id', input.getAttribute('data-redfit-id'));
        }
    }
    
    function searchSvg(path){
        let svg = path;
        while(svg.tagName.toUpperCase() !== "SVG"){
            svg = svg.parentElement;
        }
        return svg;
    }

    function init(){
        const dt = new Date();

        let dateToString = d => `${d.getFullYear()}-${('00' + (d.getMonth() + 1)).slice(-2)}-${('00' + d.getDate()).slice(-2)}`;
        $('#RutFechaInicio').val(dateToString(dt));
        $('#RutFechaFinal').val(dateToString(dt));
    }

    function setTotalSemanas(){
        const fechaInicio = parseFromStringToDate(fInitRutGen.value);
        const fechaFin = parseFromStringToDate(fFinRutGen.value);
        const totDias = moment(fechaFin).diff(fechaInicio, 'days') + 1;
        const diasPrimeraSemana = fechaInicio.getDay() == 0 ? 1 : 7 - fechaInicio.getDay() + 1;
        document.querySelector('#MacroTotalSemanas').textContent = diasPrimeraSemana == 7 ? Math.ceil(totDias / 7) : 1 + Math.ceil((totDias - diasPrimeraSemana) / 7);
    }

    function eventosGeneralesFocusOut(e){

        if(e.target.classList.contains('nota-cliente')){
            let id = e.target.getAttribute('data-id');
            let nota = e.target.value.trim();
            let params = {};
            params.id = id;
            params.nota = nota;
            if($nota != nota){
                $.ajax({
                    type: 'PUT',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    url: _ctx+'gestion/trainer/red/anadir-nota',
                    data: params,
                    dataType: 'json',
                    success: (d)=>{
                        if(d=="-2"){

                            if($nota != ""){
                                if(nota == ""){
                                    e.target.parentElement.parentElement.querySelector('.ico-nota').children[0].classList.toggle('txt-color-grayDark');
                                    e.target.parentElement.parentElement.querySelector('.ico-nota').children[0].classList.toggle('txt-color-yellow');
                                }
                            }else{
                                e.target.parentElement.parentElement.querySelector('.ico-nota').children[0].classList.toggle('txt-color-grayDark');
                                e.target.parentElement.parentElement.querySelector('.ico-nota').children[0].classList.toggle('txt-color-yellow');
                            }
                            //Actualizando campo nota popover
                            e.target.parentElement.parentElement.querySelector('.ico-nota').setAttribute('data-content', nota);
                            e.target.parentElement.remove();
                        }
                    },error: (xhr)=>{
                        exception(xhr);
                    }
                    ,complete: ()=>{}
                })
            }else{
                e.target.parentElement.remove();
            }
        }
    }

    function actualizarNota(){
        const eleNota = mdlNota.querySelector('textarea');
        const nota = eleNota.value;
        const id = Number(eleNota.getAttribute('data-redfit-id'));
        let params = {
            id: id,
            nota: nota
        };
        $.ajax({
            type: 'PUT',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/trainer/red/anadir-nota',
            data: params,
            dataType: 'json',
            success: (d)=>{
                $.smallBox({content: 'Actualización exitosa'});
            },error: (xhr)=>{
                exception(xhr);
            }
            ,complete: ()=>{
                listarRegistros();
                $(mdlNota).modal('hide');
            }
        })
    }

    function listarRegistros() {

        if ($("#frm_busqueda").valid()) {
            const data = getFormData($("#frm_busqueda"));
            $table.bootstrapTable('destroy');
            $table.bootstrapTable({
                url: _ctx + 'gestion/trainer/red/obtenerListado',
                pagination: true,
                sidePagination: 'client',
                pageSize: 10,
                queryParams: ()=> {
                    return data;
                },
                onLoadSuccess: d => {
                    //Activando los popover y tooltips
                    d.forEach(r=>{
                        r.estadoPlan == 1 ? ++$countSinPlan : '';
                        r.estadoPlan == 2 ? ++$countPendientesEnvio : '';
                    })
                    $('[data-toggle="popover"]').popover();
                    $('[rel="tooltip"]').tooltip();
                    $('.total-pe').text($countPendientesEnvio);
                    $('.total-pp').text($countSinPlan);
                    instanceSvgAndPopovers();
                },
                onLoadError: function (xhr) {
                    exception(xhr);
                },
            });
        }
    }

    function noCuentaConPrograma(){
        $.smallBox({color: "info", content: "<i>El atleta aún no cuenta con ninguna rutina asignada...</i>"})
    }

    function linkFormatter(value, row) {
        if(row.contadorRutinas == 0){
            return String('<a style="text-decoration: none;" href="#" onclick="javascript:noCuentaConPrograma()" title="El atleta aún no cuenta con ninguna rutina asignada" rel="tooltip">' + row.cliNombreCompleto + '</a>', value);
        }else{
            return String('<a style="text-decoration: none;" href="#" onclick="javascript:verUltimoPrograma(' + row.id +','+ row.cliId +',\''+ btoa(row.cliFechaNacimiento) +'\',\''+ btoa(row.cliNombreCompleto) + '\')" title="↗️ Ir al último programa" rel="tooltip">' + row.cliNombreCompleto + '</a>', value);
        }
    }

    function fttNota(v, row, ix){
        let opciones = '';
        let nota = row.nota == null?"":row.nota;
        if(nota == ""){
            opciones = `<img data-redfit-id="${row.id}" style="fill:#9d9d9d !important;" data-placement="top" data-toggle="popover" data-content="${nota}" data-trigger="hover" class="svg ico-nota" id="svg${ix}" data-ix="${ix}" src="${_ctx}img/iconos/icon_edit.svg"/>`;
        }else{
            opciones = `<img data-redfit-id="${row.id}" data-placement="top" data-toggle="popover" data-content="${nota}" data-trigger="hover" class="svg ico-nota" id="svg${ix}" data-ix="${ix}" src="${_ctx}img/iconos/icon_leyenda.svg"/>`;
        }
        return opciones;
    }

    function fttNp(v, row, ix, pos){
        return `<img class="svg" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_edit.svg"/>`;
    }

    function fttPlantillas(v, row, ix){
        var opciones = "";
        switch(row.estadoPlan) {
            case EstadoPlan.SIN_PLAN:
                let fnNuevoRutina = "crearNuevaRutina";
                if(row.predeterminadaFichaId == TipoFicha.GENERAL){
                    objForRutina.redFitId = row.id;
                    objForRutina.cliId = row.cliId;
                    objForRutina.ix = ix;
                    objForRutina.contadorRutinas = row.contadorRutinas;
                    fnNuevoRutina = "abrirModalRutinaGen";
                }
                opciones += `<img class="svg"
                                title="Crear rutina" rel="tooltip"
                                onclick='javascript:${fnNuevoRutina}(${row.id},${row.cliId},${ix}, ${row.contadorRutinas}, ${"\"" + btoa(row.cliFechaNacimiento) + "\""}, ${"\"" + btoa(row.cliNombreCompleto) + "\""});'
                                src="${_ctx}img/iconos/iconos_RunFit_programa copia.svg"/>`
                break;
            case EstadoPlan.EN_REVISION:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_programa copia.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            case EstadoPlan.POR_ENVIAR:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_programa copia.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            case EstadoPlan.INICIADO:
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_programa copia.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
            default://EstadoPlan.CULMINADO
                opciones +=`<img class="svg" src="${_ctx}img/iconos/iconos_RunFit_programa copia.svg" title="Ya se ha asignado una rutina al cliente" rel="tooltip">`;
                break;
        }
        return opciones;
    }
    function fttMeses(v, row, ix){
        return `<img class="svg" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_archivo.svg"/>`;
    }
    function fttTemporada(v, row, ix){
        return `<img class="svg" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_edit.svg"/>`;
    }
    function fttEnviarCorreo(v, row, ix){
        return `<img class="svg" onclick="preNotificacionPersonal(${row.cliId}, '${row.cliCorreo}')" data-redfit-id="${row.id}" src="${_ctx}img/iconos/icon_mail.svg"/>`;
    }

    function instanceSvgAndPopovers(){
        $('tbody img.svg').each(function () {
            var $img = jQuery(this);
            var imgURL = $img.attr('src');
            var element = $img[0];

            $.get(imgURL, function (data) {
                var $svg = $(data).find('svg');
                $img[0].getAttributeNames().forEach(e=>{
                    $svg = $svg.attr(e, element.getAttribute(e));
                })
                $svg = $svg.removeAttr('xmlns:a');
                if (!$svg.attr('viewBox') && $svg.attr('height') && $svg.attr('width')) {
                    $svg.attr('viewBox', '0 0 ' + $svg.attr('height') + ' ' + $svg.attr('width'));
                }
                $img.replaceWith($svg);
                if($svg[0].hasAttribute('rel')){
                    $($svg[0]).tooltip();
                }
                if($svg[0].classList.contains('ico-nota')){
                    $($svg[0]).popover();
                }

            }, 'xml');

        });
    }

    function Opciones(value, row, index) {
        let opciones = '';

        switch(row.estadoPlan) {

            case EstadoPlan.SIN_PLAN:
                let fnNuevoRutina = "crearNuevaRutina";
                if(row.predeterminadaFichaId == TipoFicha.GENERAL){
                    objForRutina.redFitId = row.id;
                    objForRutina.cliId = row.cliId;
                    objForRutina.ix = index;
                    objForRutina.contadorRutinas = row.contadorRutinas;
                    fnNuevoRutina = "abrirModalRutinaGen";
                }
                opciones += `<a data-toggle="modal" data-target="#myModalPlantillas"  onclick='javascript:asignarPlantilla(${row.id}, ${row.cliId},"${row.cliCorreo}",${index});' title='Asignar Rutina'><i class='fa fa-file-text fa-2x'></i></a> &nbsp &nbsp
                             <a href='#' onclick='javascript:${fnNuevoRutina}(${row.id},${row.cliId},${index}, ${row.contadorRutinas}, ${"\""+btoa(row.cliFechaNacimiento)+"\""}, ${"\""+btoa(row.cliNombreCompleto)+"\""});' title='Crear Rutina'><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`

                break;
            case EstadoPlan.EN_REVISION:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            case EstadoPlan.POR_ENVIAR:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            case EstadoPlan.INICIADO:
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
            default://EstadoPlan.CULMINADO
                opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class="fa fa-file-text fa-2x"></i></a> &nbsp &nbsp
                            <a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="Ya se ha asignado una rutina al cliente" rel="tooltip"><i class='fa fa-plus fa-2x'></i></a> &nbsp &nbsp`;
                break;
        }
        opciones +=`<a href='javascript:void(0);' class="txt-color-grayDark" data-placement="top" data-original-title="La revisión de la rutina aún no ha sido aprobada" rel="tooltip"><i class="fa fa-send-o fa-2x"></i></a> &nbsp &nbsp`;
        opciones +=`<a href='#' onclick='javascript:crearNuevaRutina(${row.id},${row.cliId},${index}, ${row.contadorRutinas}, ${"\""+btoa(row.cliFechaNacimiento)+"\""}, ${"\""+btoa(row.cliNombreCompleto)+"\""});' title='Crear Rutina'><i class='fa fa-check fa-2x'></i></a>`;
        return opciones;
    }

    function abrirModalRutinaGen(){
        $('#myModalRutGen').modal('show');
    }

    function crearNuevaRutinaGeneral(){
        const rutina = getBasicosNueRutGen();
        rutina.redFitnessId = objForRutina.redFitId;
        rutina.clienteId = objForRutina.cliId;
        rutina.control = {};
        rutina.control.avanceSemanas = new Array(rutina.totalSemanas).fill("");

        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: _ctx + "gestion/rutina/nueva/general",
            dataType: "json",
            bridgeMultipart: false,
            data: JSON.stringify(rutina),
            success: function (data) {
                const id = data.res;
                const rn = data.rdm;
                window.location.href = _ctx + 'rutina/edicion?key=' + id + '&rn=' + rn;//res.id para el caso = redFitnessId;
            },
            error: function (xhr) {
                exception(xhr);
            },
            complete: function () {}
        })

    }

    function getBasicosNueRutGen(){
        const $chelmoMacro = [];
        const totalSemanas = $('#MacroTotalSemanas').text().trim();
        //Semanas
        const fIni = parseFromStringToDate(document.querySelector('#RutFechaInicio').value);
        let fFin = parseFromStringToDate(document.querySelector('#RutFechaFinal').value);
        for(let i=0; i<totalSemanas;i++){
            const refDia = fIni.getDay();
            let diasParaFull = refDia==0?0:7-refDia;
            if(i == 0){
                const objFirtsWeek = {};
                objFirtsWeek.fechaInicio = moment(fIni).add((i*7), 'd').format('DD/MM/YYYY');
                objFirtsWeek.fechaFin = moment(fIni).add((i*7)+diasParaFull, 'd').format('DD/MM/YYYY');
                objFirtsWeek.flagFull = refDia == 1 ? true : false;
                const literales = ["Domingo", "Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sábado", "Domingo"];//Artificio temporal(2 domingos)
                const dias = [];
                for(let i=0; i<diasParaFull+1; i++){
                    const fechaParse = parseFromStringToDate2(moment(fIni).add((i), 'd').format('DD/MM/YYYY'));
                    dias.push({fecha: moment(fIni).add((i), 'd').format('DD/MM/YYYY'), dia: fechaParse.getDate(), flagDescanso: false, literal: literales[fechaParse.getDay()], diaLiteral: fechaParse.getDate() + " "+ literales[fechaParse.getDay()]});
                }
                objFirtsWeek.lstDia = dias;
                $chelmoMacro.push(new Semana(objFirtsWeek))
            } else{
                $chelmoMacro.push(new Semana(undefined, parseFromStringToDate(moment($chelmoMacro[i-1].fechaFin).add(1, 'd').format('YYYY-MM-DD')),parseFromStringToDate(moment($chelmoMacro[i-1].fechaFin).add(7, 'd').format('YYYY-MM-DD'))));
            }
        }

        //Modificando fecha fin de la ultima semana en caso esta no se encuentre mapeada con los 7 días calendarios
        $chelmoMacro[totalSemanas-1].fechaFin = fFin;
        //Rutina
        const r = {};
        r.fechaInicio = fIni;
        r.fechaFin = fFin;
        r.dias = moment(fFin).diff(fIni, 'days') + 1;
        r.meses = Math.floor(r.dias/30);
        r.anios = Math.floor(r.meses/12);
        r.totalSemanas = Number(totalSemanas);
        r.semanas = $chelmoMacro;
        return r;
    }

    function crearNuevaRutina(id, clienteId, index, contadorRutinas, fechaNac, cliFullNombre){
        const datosAsURI = '&fn=' + fechaNac + '&nm=' + cliFullNombre;
        id = getHash32Id('rf-rutina', id);
        clienteId = getHash16Id('rf-rutina', clienteId);
        $.SmartMessageBox({
            title: "<i class='fa fa-bullhorn'></i> Workout Notification",
            content: "" +
                "<br/><h6>Confirmar:</h6>",
            buttons: '[NO][SI]'
        }, function (ButtonPressed) {
            if (ButtonPressed === "SI") {
               window.location.href = _ctx+'rutina/pre?key='+id + '&rn='+clienteId + datosAsURI;//res.id para el caso = redFitnessId;
            }
        });

        setFechaActual(document.querySelectorAll('input[type="date"]'));

    }

    function verUltimoPrograma(redFitnessId, clienteId, fechaNac, cliFullNombre){
        const datosAsURI = '&fn=' + fechaNac + '&nm=' + cliFullNombre;
       window.location.href = _ctx+'rutina/edicion?key='+ getHash32Id('rf-rutina', redFitnessId) + '&rn='+ getHash16Id('rf-rutina', clienteId)+datosAsURI;
    }

    function estadoPlan(value, row){
        let icon = '';
        switch(row.estadoPlan){
            case EstadoPlan.SIN_PLAN:
                icon = `<span href="#" class="label label-danger"><i class="fa fa-warning fa-fw"></i> Sin Plan</span>`;
                break;
            case EstadoPlan.EN_REVISION:
                icon = `<span href="#" class="label label-info"><i class="fa fa-dot-circle-o fa-fw"></i> En Revisión</span>`;
                break;
            case EstadoPlan.POR_ENVIAR:
                icon = `<span href="#" class="label label-warning"><i class="fa fa-send fa-fw"></i> Pendiente de Envío</span>`;
                break;
            case EstadoPlan.INICIADO:
                icon = `<span href="#" class="label label-default bg-color-orange"><i class="fa fa-bolt fa-fw"></i> Plan Iniciado</span>`;
                break;
            default://EstadoPlan.COLMINADO
                icon = `<span href="#" class="label label-success"><i class="fa fa-check fa-fw"></i> Plan Finalizado</span>`;
                break;
        }
        return icon;
    }

    function formatterFechaInicialPlanificacion(value){
        if(value != undefined){
            return value;
        }
        return "-";
    }

    function formatterFechaFinalPlanificacion(value){
        if(value != undefined){
            let fecha = parseFromStringToDate2(value);
            let diasParaUltimaFecha = moment(fecha).diff(new Date(), 'days');
            if(diasParaUltimaFecha <8){
                return `<span href="#" class="label txt-color-red">${value}</span>`
            }else if(diasParaUltimaFecha <15){
                return `<span href="#" class="label txt-color-orangeDark">${value}</span>`
            }else{
                return `<span href="#" class="label txt-color-greenLight">${value}</span>`
            }
        }
        return "-";
    }

    function asignarPlantilla(redId, clienteId, correo , index){
        let plantillas = document.querySelector('#Plantillas');
        document.querySelector('#spRaw3').innerHTML = spinnerHTMLRawCsMessage('Cargando...');
        let params = {};
        params.clienteId = clienteId;
        params.redFitnessId = redId;
        $('#CorreoCliente').text(correo);
        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx + 'gestion/rutina-plantilla/trainer/red/obtenerListado',
            dataType: 'json',
            data: params,
            success: function(data){
                if(data.length>0){
                    let htmlRaw = '';
                    data.forEach((plantilla,i)=>{
                        htmlRaw += `    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                            <div class="row" style="border-radius: 5%;margin:5px;background: #cae6b9 !important;">
                                                <a href="#" onclick="javascript:elegirPlantillaParaCliente(${plantilla.id}, ${index});" class="elegir-plantilla" data-plantilla-id="${plantilla.id}" >
                                                    <h6 class="text-align-center bg-color-lighten txt-color-orangeDark">${i+1}</h6>
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" >
                                                        <h6>Años: </h6>
                                                        <h6>Meses: </h6>
                                                        <h6>Semanas: </h6>
                                                        <h6>Dias: </h6>
                                                    </div>
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                                        <h6 class="text-align-center">${plantilla.anios} </h6>
                                                        <h6 class="text-align-center">${plantilla.meses} </h6>
                                                        <h6 class="text-align-center">${plantilla.totalSemanas} </h6>
                                                        <h6 class="text-align-center">${plantilla.dias}  </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </div>`
                    })

                    plantillas.innerHTML = htmlRaw;
                }else{
                    plantillas.innerHTML = '<h6 class="text-align-center"><b>No se encontraron plantillas registradas...</b></h6>'
                }
            },
            error: function(xhr){
            },
            complete: function(){

            }
        })
    }

    function elegirPlantillaParaCliente(rutinaPlantillaId, ix){
        document.querySelector('#myModalPlantillas #Plantillas').innerHTML = spinnerHTMLRawCsMessage('Notificando a cliente... Espere por favor...');
        //ix: Nos servira para actualizar en el dom el flagEnActividad
        var actualStatus = document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').textContent;
        let params = {};
        params.rutinaPlantillaId = rutinaPlantillaId;
        params.correo = document.querySelector('#CorreoCliente').textContent.trim();

        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx + 'gestion/rutina/agregar',
            dataType: 'json',
            data: params,
            success: function(){
                $.smallBox({content: '<i>Se le ha asignado exitosamente la rutina al cliente...</i>'})
                actualStatus == "Activo" ?
                    document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').innerHTML = '<span class="label label-success">Activo</span>'
                    :
                    document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\'] .td-status').innerHTML= '<span class="label label-success">Activo</span>'
                //Removiendo la accion al boton de asignar
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('onclick');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('data-toggle');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].removeAttribute('data-target');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].style.color="gray";
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[0].title="Ya se ha asignado una rutina al cliente";
                //2.
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].removeAttribute('onclick');
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].style.color="gray";
                document.querySelector('#tblRegistros tbody tr[data-index=\'' + ix + '\']').lastChild.children[1].title="Ya se ha asignado una rutina al cliente";
                $('#myModalPlantillas').modal('hide');
            },
            error: function(xhr){
            },
            complete: function(){
            }
        })
    }

    function eventosClickModalPlantillas(e){}//No implemetada
</script>

</body>

</html>

<!DOCTYPE html>
<html lang="en-us" style="background-color: #fff;"
      xmlns:th="http://www.thymeleaf.org"
      th:with="version = ${#servletContext.getAttribute('version')}">
<head>
    <title>Mis clientes</title>
    <th:block th:insert="html-commons/tr/meta :: fg-meta"></th:block>
    <th:block th:insert="html-commons/tr/css  :: fg-css"></th:block>
</head>
<style>

 .btn-circle{
     float: right!important;
     border-radius: 50%;
      font-size: 20px;
     background-color: gainsboro;
     color: #fff;
 }
</style>
<body style="background-color: #fff;">
<div id="wrapper">

    <div class="modal fade" id="modalNuevaCategoria" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <section id="nuevaCategoriaPlantilla">
                <div class="modal-content">
                    <div class="modal-header" style="background-color:black">
                        <strong>NUEVA CATEGORÍA</strong>  <i class="i-btn fa fa-close fa-15x txt-color-blueLight pull-right" data-dismiss="modal"></i>
                    </div>

                    <div class="modal-body">
                        <div class="container-fluid padding-0 text-align-center" id="nuevaCategoria">
                            <form id="nueva_categoria_frm"  method="post">

                                <div class="form-group form-alt">
                                    <label>NOMBRE </label>
                                    <input id="nombreCategoria" name="Nombre" type="text">
                                </div>
                                <div class="form-group form-alt">
                                    <label> TIPO DE RUTINA </label>

                                    <ul class="checks text-center">
                                        <li>
                                            <label class="chk-content">PLANTILLA ESTÁNDAR
                                                <input type="radio" name="cbNuevaCategoria" value="0"><span class="checkmark"></span>
                                            </label>
                                        </li>
                                        <li>
                                            <label class="chk-content">PLANTILLA RUNNING
                                                <input type="radio" name="cbNuevaCategoria" value="1"><span class="checkmark"></span>
                                            </label>
                                        </li>
                                    </ul>


                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-md" onclick="agregarCategoria()">AGREGAR CATEGORIA</button>
                    </div>
         </div>
        </section>

     </div>
</div>

    <div class="modal fade" id="modalEditarCategoria" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <section id="editarCategoriaPlantilla">
                <div class="modal-content">
                    <div class="modal-header" style="background-color:black">
                        <strong>EDITAR CATEGORÍA</strong>  <i class="i-btn fa fa-close fa-15x txt-color-blueLight pull-right" data-dismiss="modal"></i>
                    </div>

                    <div class="modal-body">
                        <div class="container-fluid padding-0 text-align-center" id="editarCategoria">
                            <form id="editar_categoria_frm"  method="post">

                                <div class="form-group form-alt">
                                    <label>NOMBRE </label>
                                    <input id="nombreCategoriaEdit" name="Nombre" type="text">
                                </div>
                                <div class="form-group form-alt">
                                    <label> TIPO DE RUTINA </label>

                                    <ul class="checks text-center">
                                        <li>
                                            <label class="chk-content">PLANTILLA ESTÁNDAR
                                                <input type="radio" name="cbEditarCategoria" value="0"><span class="checkmark"></span>
                                            </label>
                                        </li>
                                        <li>
                                            <label class="chk-content">PLANTILLA RUNNING
                                                <input type="radio" name="cbEditarCategoria" value="1"><span class="checkmark"></span>
                                            </label>
                                        </li>
                                    </ul>


                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-md"  id="btnEditarCategoria" onclick="actualizarCategoriaPlantilla()">EDITAR CATEGORIA</button>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <div class="modal fade" id="modalNuevaRutina" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <section id="nuevaRutinaPlantilla">
                <div class="modal-content">
                    <div class="modal-header" style="background-color:black">
                        <strong>NUEVA RUTINA PREDISEÑADA</strong>  <i class="i-btn fa fa-close fa-15x txt-color-blueLight pull-right" data-dismiss="modal"></i>
                    </div>

                    <div class="modal-body">
                        <div class="container-fluid padding-0 text-align-center" id="nuevaRutina">
                            <form id="nueva_rutina_pred_frm"  method="post">

                                <div class="form-group form-alt">
                                    <label> NOMBRE </label>
                                    <input id="nombreRutina" class="form-control" name="nombre" type="text">
                                </div>

                                <div class="form-group form-alt">
                                    <label> SEMANAS </label>
                                    <input id="semanasRutina" class="form-control" name="semana" type="number">
                                </div>

                                <div class="form-group form-alt">
                                    <label> DIAS </label>
                                    <input id="diasRutina" class="form-control" name="dias" type="number">
                                </div>

                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-md" onclick="agregarRutina()">AGREGAR RUTINA PREDISEÑADA</button>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <div class="modal fade" id="modalEditarRutina" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <section id="editarRutinaPlantilla">
                <div class="modal-content">
                    <div class="modal-header" style="background-color:black">
                        <strong>EDITAR RUTINA PREDISEÑADA</strong>  <i class="i-btn fa fa-close fa-15x txt-color-blueLight pull-right" data-dismiss="modal"></i>
                    </div>

                    <div class="modal-body">
                        <div class="container-fluid padding-0 text-align-center" id="editarRutina">
                            <form id="editar_rutina_pred_frm"  method="post">

                                <div class="form-group form-alt">
                                    <label> NOMBRE </label>
                                    <input id="nombreEditRutina" class="form-control" name="nombreEdit" type="text">
                                </div>

                                <div class="form-group form-alt">
                                    <label> SEMANAS </label>
                                    <input id="semanasEditRutina" class="form-control" name="semanaEdit" type="number">
                                </div>

                                <div class="form-group form-alt">
                                    <label> DIAS </label>
                                    <input id="diasEditRutina" class="form-control" name="diasEdit" type="number">
                                </div>

                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-md" onclick="actualizarRutina()" id="btnEditarRutina">EDITAR RUTINA PREDISEÑADA</button>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <header>
        <ul class="nav nav-pills">
            <li class="col-md-3 icons"><a href="#"><img class="svg" th:src="@{/img/iconos-trainers/icon_guardar.svg}"></a><a href="#"><img class="svg" th:src="@{/img/iconos-trainers/icon_abc.svg}"></a><a href="#"><img class="svg" th:src="@{/img/iconos-trainers/icon_arrow-left.svg}"></a><a href="#"><img class="svg" th:src="@{/img/iconos-trainers/icon_arrow-right.svg}"></a></li>
            <li class="active col-md-1"><a href="#">listado</a></li>
            <li class="col-md-2"><a href="#">g. videos</a></li>
            <li class="col-md-2"><a href="#">rutinario</a></li>
            <li class="col-md-2"><a href="#">g. audios</a></li>
            <li class="col-md-2"><a href="#">planes prediseñados</a></li>
        </ul>
    </header>
    <div class="container-t"><img class="logoBlack" th:src="@{/img/logo_black.png}">

        <h2 class="title_carousel dots">planes<span>- pre diseñados</span></h2>

        <a data-toggle="modal" data-target="#modalNuevaCategoria" type="button" href="#" class="btn btn-circle btn-lg"  title="Registrar">
           <i class="fa fa-plus fa-2x"></i>
        </a>

        <ul class="checks text-center">
            <li>
                <label class="chk-content">PLANTILLA ESTÁNDAR
                    <input type="checkbox" class="radio" name="cbSeleccionTipo" value="0"><span class="checkmark"></span>
                </label>
            </li>
            <li>
                <label class="chk-content">PLANTILLA RUNNING
                    <input type="checkbox" class="radio" name="cbSeleccionTipo" value="1"><span class="checkmark"></span>
                </label>
            </li>
        </ul>
        <div class="owl-carousel owl-theme" id="planesCarousel">

        </div>
        <div class="shadow-gris">
            <div class="container-t">
                <div class="slider-container">
                    <input class="range-slider" type="range" id="range" value="0" name="range" min="0" step="1" max="5">
                </div>
            </div>
        </div>

    </div>

    <section id="info">
        <div class="container-t">
            <div class="text-center">
                <div class="form-group pull-left">
                    <div class="search">
                        <div class="input-group">
                            <input class="form-control" type="text">
                        </div>
                    </div>
                </div><a class="scroll" href="#"><img class="svg" th:src="@{/img/iconos-trainers/icon_arrow-top.svg}"></a>
                <div class="form-group pull-right">
                    <select class="form-control">
                        <option>1 - plan de 1 semanas</option>
                    </select>

                    <a data-toggle="modal" data-target="#modalNuevaRutina" type="button" href="#" class="btn btn-circle btn-lg" id="btnNuevaRutina" title="Nueva Rutina">
                        <i class="fa fa-plus fa-2x"></i>
                    </a>

                </div>
            </div>
            <div class="clearfix"></div>
            <h1 class="title_big">15<span>km - </span><i>intermedios</i></h1>
            <ul class="list_plan">
          </ul>
            <div class="clearfix"></div>
        </div>
    </section>

</div>


<th:block th:insert="html-commons/tr/js :: fg-js"></th:block>
<!-- OTRAS LIBRERIAS DISTINTAS AL TEMPLATE -->

<script th:inline="javascript">

    const body = document.getElementsByTagName("body")[0];
    const owl = $('.owl-carousel');
    const cbox = $('input[type="radio"][name="cbNuevaCategoria"]');
    const mdlEditarCat = document.getElementById("modalEditarCategoria");
    const mdlEditarRutina = document.getElementById("modalEditarRutina");
    const mdlAgregarCat = document.getElementById("modalNuevaCategoria");
    const btnEditarCat = document.getElementById("btnEditarCategoria");
    const mdlAgregarRutina = document.getElementById("modalNuevaRutina");
    const btnEditarRutina = document.getElementById("btnEditarRutina");
    const btnNuevaRutina = document.getElementById("btnNuevaRutina");
    const ulListRutina = $('.list_plan');
    let dataCategorias;

    $(function(){



        onInit();

    })

    function onInit(){
        checkBoxTipoChangeEvent();
        checkBoxasRadioButtons()
        obtenerCategorias();
        owl.on('click', '.item', categoriaClickListenerEvent);
        ulListRutina.on('click', 'li', rutinaClickListenerEvent);

    }

    function agregarCategoria(){

        const nombre = $('#nombreCategoria').val()
        const tipoRutina = $('input[type="radio"][name="cbNuevaCategoria"]:checked').val();

        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/categoria-plantilla/agregar',
            data: {nombre :nombre,
                   tipo: tipoRutina } ,
            dataType: 'json',
            success: (data) =>  {


            } ,
            error: (d) =>{

            },
            complete: (d) =>{
                $(mdlAgregarCat).modal('hide');
                obtenerCategorias();
            }




        })

    }


    function obtenerCategorias(){

   //     const nombre = $('#nombreCategoria').val()
   //     const tipoRutina = $('input[type="checkbox"][name="cbSeleccionTipo"]:checked').val();

        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            url: _ctx+'gestion/categoria-plantilla/obtener',
            dataType: 'json',
            success: (data) =>  {
                dataCategorias = data;
                obtenerCategoriasPlantillas(dataCategorias);
            } ,
            error: (d) =>{

            },
            complete: (d) =>{

                $(".item-body a").click(function (e) {

                    const input = e.target;
                    let categoriaId;
                    let catNombre;

                    if(input.tagName.toUpperCase() === 'SVG'){

                        const dsCategoria = e.currentTarget.dataset;
                         categoriaId = dsCategoria.categoriaId;
                         catNombre = dsCategoria.nombre;


                    }else if (input.tagName.toUpperCase() === 'A'){

                        categoriaId = input.getAttribute('data-categoria-id');
                        catNombre = input.getAttribute('data-nombre');
                    }

                    $('section#info .title_big').text(catNombre);

                    btnNuevaRutina.setAttribute('data-categoria-id' , categoriaId);

                   obtenerRutinas(categoriaId);


                    $("section#info").slideDown(200);
                    $( 'html, body' ).stop().animate({
                        scrollTop: $("section#info").offset().top
                    });
                    return false;
                });
                $(".scroll").click(function() {
                    $("section#info").slideUp(200);
                    $('html, body').animate({
                        scrollTop: 0
                    }, 800);
                    return false;
                });


            }
        })

    }

    function actualizarCategoriaPlantilla(){

        const nombre = $('#nombreCategoriaEdit').val()
        const tipoRutina = $('input[type="radio"][name="cbEditarCategoria"]:checked').val();
        const idCategoria = Number(btnEditarCat.getAttribute("data-categoria-id"));

        console.log(idCategoria);

        $.ajax({
            type: 'PUT',
            url: _ctx + "gestion/categoria-plantilla/actualizar",
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            data:  { id: idCategoria ,nombre : nombre , tipo: tipoRutina},
            dataType : 'json',
            success: (d) =>{
                console.log(d);
            },
            error : (e) => {},
            complete: (c) =>{
                obtenerCategorias();
                $(mdlEditarCat).modal('hide');
            }

            })
    }

    function obtenerCategoriasPlantillas(dataCategorias){

        let itemsCategoria = "";
        dataCategorias.forEach(function(element) {
            itemsCategoria += `
           <div class="item" >
                <div class="item-header"><a class="star"><img class="svg" src="/img/iconos-trainers/icon_star.svg"></a><a data-toggle="modal" data-target="#modalEditarCategoria" type="button" href="#"><img class="svg icon-edit" src="/img/iconos-trainers/icon_edit.svg" data-categoria-id ="${element.id}"  data-nombre="${element.nombre}" data-tipo ="${element.tipo}"></a><strong> ${element.nombre} </strong></div>
                <div class="item-body"><img class="svg" src="/img/iconos-trainers/icon_tablero.svg"><a data-categoria-id ="${element.id}"  data-nombre="${element.nombre}"><img class="svg" src="/img/iconos-trainers/icon_add.svg">Agregar</a></div>
             </div>
           `;
        });


        $('.owl-carousel').trigger('replace.owl.carousel', itemsCategoria).trigger('refresh.owl.carousel');
        $('.owl-stage').css('width','');
        $('.owl-item').css('width','259.8px');
        $('.owl-item').css('margin-right','10px');
        imgtoSvgEvent();

    }

    function checkBoxasRadioButtons(){

        $("input:checkbox").on('click', function() {
            let $box = $(this);
            if ($box.is(":checked")) {
                let group = "input:checkbox[name='" + $box.attr("name") + "']";
                $(group).prop("checked", false);
                $box.prop("checked", true);
            } else {
                $box.prop("checked", false);
            }
        });

    }

    function checkBoxTipoChangeEvent() {

        $("input:checkbox").on('change', function () {
            let cbSeleccionado = $(this)[0].value;

           if($("input:checkbox[name='cbSeleccionTipo']:checked").length === 0){
               obtenerCategoriasPlantillas(dataCategorias);
           }else{
                let dataCategoriasTipo = dataCategorias.filter( (e) => e.tipo ===  Number(cbSeleccionado) );
                obtenerCategoriasPlantillas(dataCategoriasTipo);
           }
        })
    }


    function categoriaClickListenerEvent(e){
        const input = e.target;
        const clases = input.classList;

        console.log(e);


        if(input.tagName.toUpperCase() === 'PATH'){

            const svg = searchSvg(input);

            const nombre = svg.getAttribute("data-nombre");
            const idCategoria = svg.getAttribute("data-categoria-id");

            const tipoCategoria = Number(svg.getAttribute("data-tipo"));

            const txtNombre = mdlEditarCat.querySelector('#nombreCategoriaEdit');
            const cbTipoCategoria = mdlEditarCat.querySelectorAll('input[type="radio"][name="cbEditarCategoria"]');
            txtNombre.value = nombre;
            cbTipoCategoria[tipoCategoria].checked = true;

            btnEditarCat.setAttribute("data-categoria-id",idCategoria);

        }

        if(clases.contains('icon-edit')){
            const nombre = input.getAttribute("data-nombre");
            const idCategoria = input.getAttribute("data-categoria-id");
            const tipoCategoria = Number(input.getAttribute("data-tipo"));
            const txtNombre = mdlEditarCat.querySelector('#nombreCategoriaEdit');
            const cbTipoCategoria = mdlEditarCat.querySelectorAll('input[type="radio"][name="cbEditarCategoria"]');
            txtNombre.value = nombre;
            cbTipoCategoria[tipoCategoria].checked = true;
            btnEditarCat.setAttribute("data-categoria-id",idCategoria);
        }
    }

    function rutinaClickListenerEvent(e){
        const input = e.target;
        const clases = input.classList;

        const txtNombre = mdlEditarRutina.querySelector('#nombreEditRutina');
        const txtSem = mdlEditarRutina.querySelector('#semanasEditRutina');
        const txtDias = mdlEditarRutina.querySelector('#diasEditRutina');
        let id,nombre,semanas,dias;


        if(input.tagName.toUpperCase() === 'PATH') {
            const svg = searchSvg(input);
            id = svg.getAttribute('data-rutina-id');
            nombre = svg.getAttribute('data-rutina-nombre');
            semanas = svg.getAttribute('data-rutina-sem');
            dias = svg.getAttribute('data-rutina-dias');
            txtNombre.value = nombre;
            txtSem.value = semanas;
            txtDias.value = dias;

            btnEditarRutina.setAttribute('data-rutina-id',id);

            $(mdlEditarRutina).modal('show');
        
        
        }

        else if(clases.contains('icon-edit')){


            nombre = input.getAttribute('data-rutina-nombre');
            semanas = input.getAttribute('data-rutina-sem');
            dias = input.getAttribute('data-rutina-dias');
            id = input.getAttribute('data-rutina-id');

            txtNombre.value = nombre;
            txtSem.value = semanas;
            txtDias.value = dias;

            btnEditarRutina.setAttribute('data-rutina-id',id);

            $(mdlEditarRutina).modal('show');
        }


    }


    function searchSvg(path){
        let svg = path;
        while(svg.tagName.toUpperCase() !== "SVG"){
            svg = svg.parentElement;
        }
        return svg;
    }

    function agregarRutina(){

     const nombreRotulo = $('#nombreRutina').val();
     const semanas = $('#semanasRutina').val();
     const dias = $('#diasRutina').val();
     const id = btnNuevaRutina.getAttribute('data-categoria-id');
     const obj = {
                   nombre : nombreRotulo,
                   totalSemanas : semanas,
                   dias : dias,
                   anios : Math.floor(dias/365),
                   meses : Math.floor(dias/30),
                   categoriaPlantilla : id
                }

      console.log(id);

        $.ajax({
          type: 'POST',
          url: _ctx + 'gestion/rutina-plantilla/agregar',
          dataType:'json',
          contentType: 'application/json',
          data : JSON.stringify(obj),
          success: (s) =>{
              obtenerRutinas(id);
              $(mdlAgregarRutina).modal('hide');
              $("html, body").animate({ scrollTop: $(document).height() }, 1000);
          },
          error: (e) =>{
          },
          complete: (c) =>{
                    }
        });
    }

    function actualizarRutina(){

        const nombreRotulo = $('#nombreEditRutina').val();
        const semanas = $('#semanasEditRutina').val();
        const dias = $('#diasEditRutina').val();
        const id = btnEditarRutina.getAttribute('data-rutina-id');
        const categoriaId = btnNuevaRutina.getAttribute('data-categoria-id');

        const obj = {
            id : id,
            nombre : nombreRotulo,
            totalSemanas : semanas,
            dias : dias,
            anios : Math.floor(dias/365),
            meses : Math.floor(dias/30),
            categoriaPlantilla : categoriaId
        }


        $.ajax({
            type: 'PUT',
            url: _ctx + 'gestion/rutina-plantilla/actualizar',
            dataType:'json',
            contentType: 'application/json',
            data : JSON.stringify(obj),
            success: (s) =>{
               obtenerRutinas(categoriaId);
               $(mdlEditarRutina).modal('hide');
            },
            error: (e) =>{
            },
            complete: (c) =>{
            }
        });
    }



    function obtenerRutinas(catId){

        $.ajax({
            type: 'GET',
            url: _ctx + 'gestion/rutina-plantilla/listar',
            data: { catId: catId
              },
            dataType:'json',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
           success: (s) =>{
                generarRutinasCategoriaDOM(s)
            },
            error: (e) =>{
            },
            complete: (c) =>{
            }
        });
    }

    function generarRutinasCategoriaDOM(dataRutina){

      const ulListadoRutinas = document.getElementsByClassName('list_plan')[0];
      ulListadoRutinas.innerHTML ="";

      dataRutina.forEach( (element) =>{

          const rutina = htmlStringToElement(`
                                       <li class="col-md-4">
                                        <img class="plantilla svg" src="img/iconos-trainers/icon_leyenda.svg"> ${element.nombre.toUpperCase()}
                                        <a class="edit"><img class="svg icon-edit" src="img/iconos-trainers/icon_edit.svg" data-rutina-id="${element.id}" data-rutina-sem="${element.totalSemanas}" data-rutina-nombre="${element.nombre}" data-rutina-dias="${element.dias}"></a>
                                        </li>
          `);

           ulListadoRutinas.appendChild(rutina);
      })
      imgtoSvgEvent();
    }

    function editarRutina(){





    }
</script>
</body>
</html>


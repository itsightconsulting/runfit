<!DOCTYPE html>
<html lang="en-us"
      xmlns:th="http://www.thymeleaf.org"
      th:with="version = ${#ctx.servletContext.getAttribute('version')}">
<head>
    <!-- META -->
    <link th:replace="html-commons/meta :: fg-meta"/>
    <!-- END META -->
    <!-- CSS FILES -->
    <link th:replace="html-commons/css :: fg-css"/>
    <!-- END CSS FILES -->
</head>

<body class="">

<!-- HEADER -->
<div th:replace="html-commons/header :: fg-header"></div>
<!-- END HEADER -->

<!-- Left panel : Navigation area -->
<!-- Note: This width of the aside area can be adjusted through LESS variables -->
<div th:replace="html-commons/left-panel :: fg-left-panel"></div>
<!-- END NAVIGATION -->

<!-- MAIN PANEL -->
<div id="main" role="main">

    <!-- RIBBON -->
    <div id="ribbon">

				<span class="ribbon-button-alignment"> 
					<span id="refresh" class="btn btn-ribbon" data-action="resetWidgets" data-title="refresh"
                          rel="tooltip" data-html="true">
						<i class="fa fa-refresh"></i>
					</span> 
				</span>

        <!-- breadcrumb -->
        <ol class="breadcrumb">
            <li>Home</li>
            <li>Dashboard</li>
        </ol>
        <!-- end breadcrumb -->

        <!-- You can also add more buttons to the
        ribbon for further usability

        Example below:

        <span class="ribbon-button-alignment pull-right">
        <span id="search" class="btn btn-ribbon hidden-xs" data-title="search"><i class="fa-grid"></i> Change Grid</span>
        <span id="add" class="btn btn-ribbon hidden-xs" data-title="add"><i class="fa-plus"></i> Add</span>
        <span id="search" class="btn btn-ribbon" data-title="search"><i class="fa-search"></i> <span class="hidden-mobile">Search</span></span>
        </span> -->

    </div>
    <!-- END RIBBON -->

    <!-- MAIN CONTENT -->
    <div id="content">
        <fieldset>
            <section>
                <div class="row" id="view_list">
                    <div class="col-xs-12">
                        <h1 class="page-title txt-color-blueDark">
                            <i class="fa fa-edit fa-fw "></i>
                            Gestión
                            <span>>
												Plan
											</span>
                        </h1>
                    </div>
                    <div class="col-sm-12">
                        <div id="accordion" class="panel-group">
                            <form id="frm_busqueda">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-md-1  control-label-left" for="txtFiltro">Criterio</label>
                                        <div class="col-md-4">
                                            <input name="Filtro" id="txtFiltro" type="text"
                                                   class="form-control input-sm ignore" maxlength="24"
                                                   placeholder="Ingresa un criterio de búsqueda"/>
                                        </div>
                                        <label class="col-md-1 control-label-left" for="ddlEstado">Estado</label>
                                        <div class="col-md-2 mrg">
                                            <select name="Estado" id="Estado" class="form-control input-sm ignore">
                                                <option value="-1">TODOS</option>
                                                <option value="true">Activo</option>
                                                <option value="false">Inactivo</option>
                                            </select>
                                        </div>
                                        <div class="col-md-1 col-xs-5 col-sm-4">
                                            <button id="btnFiltrar" type="button" class="btn btn-primary   pull-right">
                                                Buscar
                                            </button>
                                        </div>
                                        <div class="col-md-2 col-xs-6 col-sm-6 col-lg-1 ">
                                            <button id="btnNuevo" type="button"
                                                    class="add_elements btn btn-primary pull-right">
                                                Nuevo
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <table id="tblRegistros" data-mobile-responsive="true"
                               class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <th data-field="id" data-halign="center" data-valign="middle" data-align="center">
                                    Código
                                </th>
                                <th data-field="nombre" data-formatter="linkFormatter" data-halign="left"
                                    data-valign="middle" data-align="left">Nombre
                                </th>
                                <th data-formatter="isActived" data-halign="center" data-valign="middle"
                                    data-align="center">Estado
                                </th>
                                <th data-formatter="Opciones" data-halign="center" data-valign="middle"
                                    data-align="center">Acciones
                                </th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>

                <div class="row" id="view_register">
                    <div class="col-xs-12">
                        <h1 class="page-title txt-color-blueDark">
                            <i class="fa fa-edit fa-fw "></i>
                            Gestión
                            <span>>
										Plan
									</span>
                        </h1>
                    </div>
                    <form id="frm_registro">
                        <div class="col-sm-12">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="Nombre">Nombre</label>
                                    <input id="Nombre" name="Nombre" type="text" placeholder="Ingresa nombre"
                                           class="form-control" maxlength="30" autocomplete="off"/>
                                    <input id="hIdPlan" name="hIdPlan" type="hidden" value="0"/>
                                    <input id="hIdTipoImagen" name="hIdTipoImagen" type="hidden" value="0"/>
                                    <input id="hWImage" name="hWImage" type="hidden" value=""/>
                                    <input id="hHImage" name="hHImage" type="hidden" value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="Descripcion">Descripción</label>
                                    <input id="Descripcion" name="Descripcion" type="text"
                                           placeholder="Ingresa descripción" class="form-control" maxlength="50"
                                           autocomplete="off"/>
                                </div>
                                <div class="form-group" style="display:none;">
                                    <input id="UploadImage" name="UploadImage" type="file" accept=".jpg,.png"
                                           class="form-control" data-show-preview="false" data-language="es"
                                           data-show-upload="false"/>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label for="Artificio"></label>
                                </div>
                                <div class="form-group">
                                    <label><input id="FlagActivo" type="checkbox" name="FlagActivo"
                                                  checked="checked"/><i></i>Activo</label>
                                </div>
                            </div>
                            <div class="col-sm-2" style="text-align:center;">
                                <div class="form-group">
                                    <label for="Artificio"></label>
                                </div>
                                <div class="form-group">
                                    <button id="btnGuardar" type="button" class="btn btn-primary">Guardar</button>
                                </div>
                                <div class="form-group">
                                    <button id="btnCancelar" type="button" class="btn btn-danger">Cancelar</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="col-sm-6">
                                <table id="tblTipoImagenes" data-mobile-responsive="true"
                                       class="table table-striped table-bordered">
                                    <thead>
                                    <tr>
                                        <th data-field="id" data-halign="center" data-valign="middle"
                                            data-align="center" data-width="40">Código
                                        </th>
                                        <th data-field="nombre" data-halign="left" data-valign="middle"
                                            data-align="left">Nombre
                                        </th>
                                        <th data-formatter="OpcionesImagenes" data-halign="center" data-valign="middle"
                                            data-align="center" data-width="40">Acciones
                                        </th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                            <div class="col-sm-4" style="text-align: center;">
                                <label><strong>Previsualizar</strong></label>
                                <div class="form-group" style="text-align: center;">
                                    <img id="ImagenPlan" style="border-radius: 5%; border: 1px solid gray;"
                                         align="middle" alt="Wildcard Image" src="/img/wildcard_image.png"
                                         class="rounded-circle" width="207" height="207"/>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </section>
        </fieldset>
    </div>
    <!-- END MAIN CONTENT -->

</div>
<!-- END MAIN PANEL -->
<!-- PAGE FOOTER -->
<div th:replace="html-commons/footer :: fg-footer"></div>
<!-- END PAGE FOOTER -->

<!-- SHORTCUT AREA : With large tiles (activated via clicking user name tag)
Note: These tiles are completely responsive,
you can add as many as you like
-->
<div id="shortcut">
    <ul>
        <li>
            <a href="inbox.html" class="jarvismetro-tile big-cubes bg-color-blue"> <span class="iconbox"> <i
                    class="fa fa-envelope fa-4x"></i> <span>Mail <span
                    class="label pull-right bg-color-darken">14</span></span> </span> </a>
        </li>
        <li>
            <a href="calendar.html" class="jarvismetro-tile big-cubes bg-color-orangeDark"> <span class="iconbox"> <i
                    class="fa fa-calendar fa-4x"></i> <span>Calendar</span> </span> </a>
        </li>
        <li>
            <a href="gmap-xml.html" class="jarvismetro-tile big-cubes bg-color-purple"> <span class="iconbox"> <i
                    class="fa fa-map-marker fa-4x"></i> <span>Maps</span> </span> </a>
        </li>
        <li>
            <a href="invoice.html" class="jarvismetro-tile big-cubes bg-color-blueDark"> <span class="iconbox"> <i
                    class="fa fa-book fa-4x"></i> <span>Invoice <span class="label pull-right bg-color-darken">99</span></span> </span>
            </a>
        </li>
        <li>
            <a href="gallery.html" class="jarvismetro-tile big-cubes bg-color-greenLight"> <span class="iconbox"> <i
                    class="fa fa-picture-o fa-4x"></i> <span>Gallery </span> </span> </a>
        </li>
        <li>
            <a href="profile.html" class="jarvismetro-tile big-cubes selected bg-color-pinkDark"> <span class="iconbox"> <i
                    class="fa fa-user fa-4x"></i> <span>My Profile </span> </span> </a>
        </li>
    </ul>
</div>
<!-- END SHORTCUT AREA -->
<script th:replace="html-commons/js :: fg-js"/>

<!-- OTRAS LIBRERIAS DISTINTAS AL TEMPLATE -->
<script th:src="@{/js/bootstrap-table.min.js}+'?'+${version}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var $table = $('#tblRegistros');
    var $tableTipoImagenes = $('#tblTipoImagenes');
    var $index = $('#hIdPlan');

    var pageNumber = 0;
    var pageSize = 0;

    $(function () {

        $('#btnNuevo').attr('style', 'display:none;');
        pageSetUp();
        listarRegistros();
        eventoSubirImagen();

        //V A L I D A T E
        validarRegistros();

        $("#btnNuevo").click(function () {
            irRegistro();
        });

        $("#btnGuardar").click(function () {
            registro();
        });

        $("#btnCancelar").click(function () {
            irListado($index);
        });

        $("#btnFiltrar").click(function () {
            listarRegistros();
        });

    });

    function listarRegistros() {

        if ($("#frm_busqueda").valid()) {

            $table.bootstrapTable('destroy');
            var dataRpta;

            var comodin = $("#txtFiltro").val();
            var estado = $("#Estado").val();

            if (comodin == null || comodin == "") {
                comodin = "0";
            }
            if (estado == null) {
                estado = "-1";
            }

            $table.bootstrapTable({

                url: '/gestion/plan/obtenerListado/' + comodin + '/' + estado,
                method: 'GET',
                pagination: true,
                sidePagination: 'local',
                queryParamsType: 'Else',
                pageSize: 10,
                queryParams: function (p) {
                    pageNumber = p.pageNumber;
                    pageSize = p.pageSize;
                    return {
                        pageNumber: p.pageNumber,
                        pageSize: p.pageSize
                    };
                },
                responseHandler: function (res) {
                    $(document).ajaxStop(function () {
                        $("#load_pace").hide();
                    })
                    return res.rows;
                }
            });
        }
    }

    function listarTipoImagenes() {

        $tableTipoImagenes.bootstrapTable('destroy');
        var dataRpta;

        $tableTipoImagenes.bootstrapTable({

            url: '/gestion/tipo-imagen/listarTodos',
            method: 'GET',
            pagination: false,
            sidePagination: 'local',
            queryParamsType: 'Else',
            pageSize: 10,
            async: false,
            queryParams: function (p) {
                pageNumber = p.pageNumber;
                pageSize = p.pageSize;
                return {
                    pageNumber: p.pageNumber,
                    pageSize: p.pageSize
                };
            },
            responseHandler: function (res) {
                $(document).ajaxStop(function () {
                    $("#load_pace").hide();
                })
                return res.rows;
            }
        });
    }

    function registro() {
        if ($("#frm_registro").valid()) {
            var $btn = $("#btnGuardar");
            $btn.button('loading');

            var params = new Object();
            params.id = $("#hIdPlan").val();
            params.nombre = $("#Nombre").val();
            params.descripcion = $("#Descripcion").val();
            params.flagActivo = $('#FlagActivo').is(':checked');


            $.ajax({
                type: 'POST',
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                url: '/gestion/plan/agregar',
                dataType: "json",
                data: params,
                success: function (data, textStatus) {
                    if (textStatus == "success") {
                        if (data == "2") {
                            bootbox.alert("Actualización exitosa.")
                        } else {
                            bootbox.alert("Registro exitoso.")
                        }
                    }
                },
                error: function (xhr) {
                    exception(xhr["status"], xhr["responseJSON"]["error"]);
                },
                complete: function() {
                    limpiarBusqueda();
                    irListado($index);
                    listarRegistros();
                    $btn.button('reset');
                }
            });
        }
    }

    function editar(id) {

        var param = new Object();
        param.id = id;

        $("#load_pace").show();
        $.ajax({
            type: 'GET',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            url: '/gestion/plan/obtenerPlan',
            dataType: "json",
            data: param,
            success: function (data, textStatus) {
                if (textStatus == "success") {
                    $("#hIdPlan").val(data["id"]);
                    $("#Nombre").val(data["nombre"]);
                    $("#Descripcion").val(data["descripcion"]);
                    $('#FlagActivo').prop('checked', data["flagActivo"]);
                }
            },
            error: function (xhr) {
                exception(xhr["status"], xhr["responseJSON"]["error"]);
            },
            complete: function() {
                limpiarBusqueda();
                irRegistro();
                listarTipoImagenes();
                cargarImagenes();
            }
        });
    }

    function desactivar(id) {

        bootbox.setLocale("es");
        bootbox.confirm("¿Estás seguro que deseas <strong>cambiar el estado </strong> del registro seleccionado?", function (result) {
            if (result) {
                var param = new Object();
                param.id = id;

                $("#load_pace").show();
                $.ajax({
                    type: 'POST',
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    url: '/gestion/plan/desactivarPlan',
                    dataType: "json",
                    data: param,
                    success: function (data, textStatus) {
                        if (textStatus == "success") {

                        }
                    },
                    error: function (xhr) {
                        exception(xhr["status"], xhr["responseJSON"]["error"]);
                    },
                    complete: function() {
                        limpiarBusqueda();
                        listarRegistros();
                    }
                });
            }
        });
    }

    function subirImagen(x, x1, x2) {
        $('#hIdTipoImagen').val(x);
        $('#hWImage').val(x1);
        $('#hHImage').val(x2);
        bootbox.confirm("¿Esta seguro que desea ingresar o actualizar la imagen?", function (result) {
            if (result) {
                $('#UploadImage')[0].click();
            }
        });
    }

    function cargarImagenes() {

        var param = new Object();
        param.id = $('#hIdPlan').val();

        $("#load_pace").show();
        $.ajax({
            type: 'GET',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            url: '/gestion/imagen-plan/listarTodos',
            dataType: "json",
            data: param,
            success: function (data, textStatus) {
                if (textStatus == "success") {
                    if (data == "-1") {
                    }
                    else {
                        var prefixId = "preImagen";
                        for (x in data) {
                            var tipoImagenId = data[x]["tipoImagen"]["id"];
                            $('#' + prefixId + tipoImagenId).attr('onclick', 'javascript:previsualizar("' + data[x]["nombreMedia"] + '")');
                            $('#' + prefixId + tipoImagenId).attr('title', 'Previsualizar imagen');
                            $('#' + prefixId + tipoImagenId).children().attr('class', 'glyphicon glyphicon-eye-open');
                            $('#' + prefixId + tipoImagenId).removeAttr('style');
                        }
                    }
                }
            },
            error: function (xhr) {
                exception(xhr["status"], xhr["responseJSON"]["error"]);
            },
            complete: function() {

            }
        });
    }

    function previsualizar(nombreMedia) {
        $('#ImagenPlan').attr('src', '/workout/media/image/plan/' + nombreMedia);
    }

    function eventoSubirImagen() {

        var _URL = window.URL || window.webkitURL;

        $("#UploadImage").change(function () {
            var w = parseFloat($('#hWImage').val());
            var h = parseFloat($('#hHImage').val());

            //submit the form here
            var file, img;
            if ((file = this.files[0])) {
                img = new Image();
                img.onload = function () {
                    if (parseFloat(this.width) <= w && parseFloat(this.height) <= h) {

                        var fileImagenPlan = $("#UploadImage").get(0).files[0];
                        var planId = $('#hIdPlan').val();
                        var tipoImagenId = $('#hIdTipoImagen').val();
                        ;

                        var data = new FormData();

                        data.append("fileImagenPlan", fileImagenPlan);
                        data.append("planId", planId);
                        data.append("tipoImagenId", tipoImagenId);

                        $.ajax({
                            type: 'POST',
                            url: '/gestion/imagen-plan/cargarImagen',
                            data: data,
                            contentType: false,
                            processData: false,
                            success: function (data, textStatus) {
                                if (textStatus == "success") {
                                    if (data == "-99") {
                                        bootbox.alert("El archivo no ha podido ser guardado debido a que excede los límites permitidos de la aplicación, que son 5MB en caso sea un solo archivo y si son más de 2, como máximo en conjunto no deben exceder a 10MB. Para mayor información comunicarse con el administrador.");
                                    }
                                }
                            },
                            error: function (xhr) {
                                exception(xhr["status"], xhr["responseJSON"]["error"]);
                            },
                            complete: function () {
                                cargarImagenes();
                                $('#UploadImage').val('');
                            }
                        });
                    } else {
                        bootbox.alert("Margenes máximos: <strong> ancho(" + w + "px), alto(" + h + "px)</strong> permitidos.");
                        $('#UploadImage').val('');
                    }
                };
                img.onerror = function () {
                    bootbox.alert("No se ha seleccionado una imagen válida: <strong>" + file.type + "");
                };
                img.src = _URL.createObjectURL(file);
            }
        });

    }

    function linkFormatter(value, row, index) {
        return String('<a class="editable editable-click" href="#" onclick="javascript:editar(' + row.id + ')" title="Editar">' + row.nombre + '</a>', value);
    }

    function Opciones(value, row, index) {
        var desactivar = '';

        if (row.id > 0) {
            desactivar = "<a href='#' onclick='javascript:desactivar(" + row.id + ");' title='Actualizar status'><i class='glyphicon glyphicon-refresh'></i></a>";
        }

        return desactivar;
    }

    function OpcionesImagenes(value, row, index) {
        var subir = '<a href="#" onclick="javascript:subirImagen(' + row.id + ',' + row.ancho + ',' + row.alto + ')" id="preImagen' + row.id + '" href="#" title="Subir imagen"><i class="glyphicon glyphicon-upload"></i></a>';
        var previsualizar = "<a id=\"preImagen" + row.id + "\" href='#' title='No existe imagen de este tipo' style='color:#848484;'><i class='glyphicon glyphicon-eye-close'></i></a>";
        return previsualizar + '  ' + subir;
    }

    function isActived(value, row, index) {

        if (row.flagActivo) {
            return '<i class="glyphicon glyphicon-ok"></i>';
        } else {
            return '<i class="glyphicon glyphicon-remove"></i>';
        }
    }

    function validarRegistros() {
        $("#frm_registro").validate({
            ignore: ".ignore",
            errorClass: "my-error-class",
            validClass: "my-valid-class",
            rules: {
                Nombre: {
                    required: true,
                    maxlength: $("#Nombre").prop("maxlength"),
                },
                Descripcion: {
                    required: true,
                    maxlength: $("#Descripcion").prop("maxlength"),
                },
            },
            messages: {
                Nombre: {
                    required: "El campo es obligatorio",
                    maxlength: $.validator.format("Este campo debe de tener como máximo {0} caracteres.")
                },
                Descripcion: {
                    required: "El campo es obligatorio",
                    maxlength: $.validator.format("Este campo debe de tener como máximo {0} caracteres.")
                },
            },
            submitHandler: function () {
                registro();
            }
        });
    }

    /*]]>*/
</script>

</body>

</html>
<!DOCTYPE html>
<html lang="en" id="extr-page"
      xmlns:th="http://www.thymeleaf.org"
      th:with="version = ${#servletContext.getAttribute('version')}">
<head>
  <title>Encuentra al trainer indicado para ti | Fitness | Runfit</title>
  <th:block th:insert="html-commons/p/meta :: fg-meta"></th:block>
  <th:block th:insert="html-commons/p/css  :: fg-css"></th:block>
  </head>
  <body>
    <nav th:replace="html-commons/p/header :: fg-header"></nav>
    <div th:replace="html-commons/reu-login :: fg-login"></div>
    <div id="wrapper">
      <div class="section banner home">
        <div class="bg-image"><img class="banner-home" th:src="@{/img/public/trainers-shadow.jpg}+'?'+${version}"/></div>
      </div>
      <section class="encuentra-tu-coach">
        <form id="frm_registro">
          <div class="container">
          <h1>Elige al especialista<span>Que se adecue a tus necesidades</span></h1>
          <div class="row">
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>BÚSQUEDA POR NOMBRE</label>
                <input class="form-control" type="text" id="Nombres" name="Nombres" placeholder="Nombre del trainer">
              </div>
            </div>
            <div class="col-md-4">  
              <div class="form-group">
                <label>UTILIZA PALABRAS CLAVES</label>
                <input class="form-control" id="Acerca" name="Acerca" type="text" placeholder="Ejem: Trail, circuitos, funcional...">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>UBICACIÓN</label>
                <select class="form-control" id="Ubigeo" name="Ubigeo">
                  <option value="">Seleccione</option>
                  <option th:each="dis : ${peLiDistritos.lstDis}" th:value="${dis.cod}" th:text="${dis.ubNombre}"></option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>SERVICIOS</label>
                <select class="form-control">
                  <option value="0">Seleccione</option>
                  <option value="1">Fisioterapia</option>
                </select>
              </div>
            </div>
            <div class="col-md-8 view-only-desktop">
              <div class="form-group">
                <label>¿DONDE QUIERES ENTRENAR?</label>
                <ul class="checks">
                  <li>
                    <div class="chk-content">Al aire libre
                      <input type="checkbox" name="FormaTrabajo" value="ai"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">Personalizado
                      <input type="checkbox" name="FormaTrabajo" value="pe"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">En grupo
                      <input type="checkbox" name="FormaTrabajo" value="eg"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">Online
                      <input type="checkbox" name="FormaTrabajo" value="on"><span class="checkmark"></span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">   
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>SEXO</label>
                <select class="form-control" id="Sexo" name="Sexo">
                  <option value="">Seleccione</option>
                  <option value="2">Femenino</option>
                  <option value="1">Masculino</option>
                </select>
              </div>
            </div>
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>IDIOMAS QUE DOMINA EL ASESOR</label>
                <select class="form-control" id="Idiomas" name="Idiomas" multiple="multiple" style="height: 100px">
                  <option value="">Seleccione</option>
                  <option th:each="ln : ${idiomas}" th:value="${ln.iso}" th:text="${ln.nombre}"></option>
                </select>
              </div>
            </div>
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>NIVEL DE RENDIMIENTO</label>
                <select class="form-control" id="Niveles" name="Niveles" multiple="multiple" style="height: 100px">
                  <option value="">Seleccione</option>
                  <option value="pr">Principiante</option>
                  <option value="in">Intermedio</option>
                  <option value="av">Avanzado</option>
                  <option value="pf">Profesional</option>
                </select>
              </div>
            </div>
          </div>
          <br/>
          <div class="row">
            <div class="col-md-6">
              <button id="btnLimpiar" class="btn btn-default btn-white view-only-desktop" type="button">LIMPIAR TODO</button>
            </div>
            <div class="col-md-6 text-right">
              <button class="btn btn-default btn-black" type="button" id="btnBuscar">BUSCAR</button>
            </div>
          </div>
          <div id="Trainers">

          </div>
        </div>
        </form>
      </section>
    </div>
    <footer th:replace="html-commons/p/footer :: fg-footer"></footer>
    <th:block th:insert="html-commons/p/js :: fg-js"></th:block>
    <script th:inline="javascript">
      const btnLimpiar = document.getElementById('btnLimpiar');
      const btnBuscar = document.getElementById('btnBuscar');

      (function(){
        btnLimpiar.addEventListener('click', limpiarMainForm);
        btnBuscar.addEventListener('click', busquedaDinamica);
        init();
      })();

      function init(){
        listarTrainers();
      }

      function listarTrainers(){
        $.ajax({
          type: 'GET',
          url: _ctx + 'p/trainer/find/all',
          dataType: 'json',
          blockLoading: false,
          success: function (res) {
            recrearListado(res);
          }, error: (xhr) => {
            console.log(xhr);
          }, complete: () => {
          }
        })
      }

      function busquedaDinamica(){
        const d = getFormData($('#frm_registro'));
        d.niveles = Array.from(document.getElementById('Niveles').querySelectorAll("option:checked"),e=>e.value).join('|');
        d.idiomas = Array.from(document.getElementById('Idiomas').querySelectorAll("option:checked"),e=>e.value).join('|');
        d.formasTrabajo = getValuesConcatInpCheckbox('FormaTrabajo');

        Object.keys(d).forEach(key=>{
          if(!d[key]){
            delete d[key];
          };
        })
        if(d.hasOwnProperty("ubigeo")){
          d.ubigeo = "1501"+d.ubigeo;//Prefix Lima Perú
        }
        console.log(d);
        $.ajax({
          type: 'GET',
          url: _ctx + 'p/trainer/find/dinamico',
          dataType: 'json',
          data: d,
          blockLoading: true,
          success: function (res) {
            document.getElementById('Trainers').innerHTML = "";
            if(res.length === 0){
              const noOne = document.createElement('div');
              noOne.className = "";
              noOne.style.fontSize = "1.5em";
              noOne.style.color = "#a8fa00";
              noOne.style.padding = "15px 0px";
              noOne.innerHTML = "<i class='fa fa-info-circle fa-fw'></i>No se ha encontrado ninguna coincidencia. Pruebe nuevamente con otra búsqueda";
              document.getElementById('Trainers').appendChild(noOne);
            }else{
              recrearListado(res);
            }
          }, error: (xhr) => {
              exception(xhr);
          }, complete: () => {
          }
        })
      }

      function recrearListado(arr){
        const divTrainers = document.getElementById('Trainers');
        arr.forEach((e)=>{
          const acLen = e.acerca.length;
          if(acLen > 540){
            e.acerca = e.acerca.slice(0, 540).trim();
              if(e.acerca.lastIndexOf(".") === e.acerca.length-1){
                e.acerca = slice.replace(0,539);
              }
              e.acerca += "...";
          };

          const valoraciones = e.canPerValoracion;
          const acumuladoValoracion = e.totalValoracion;
          const valoracion = valoraciones === 0 ? 0 : (acumuladoValoracion/valoraciones).toFixed(1);
          const nomLink = e.nomPag;
          divTrainers.appendChild(htmlStringToElement(`
          <div class="group-trainer row">
              <div class="col-md-3 pad-0">
              <div class="avatar-form">
              <div class="avatar-form-content"><img src="https://s3-us-west-2.amazonaws.com/rf-profile-imgs/trainer/${e.id}/${e.nomImgPerfil}" style="max-height: 100%;height: 100%; !important;"></div>
              <fieldset class="rating">
              <label class="full" for="star5" title="Awesome - 5 stars"></label>
              <label class="half" for="star4half" title="Pretty good - 4.5 stars"></label>
              <label class="full" for="star4" title="Pretty good - 4 stars"></label>
              <label class="half" for="star3half" title="Meh - 3.5 stars"></label>
              <label class="full" for="star3" title="Meh - 3 stars"></label>
              <label class="half" for="star2half" title="Kinda bad - 2.5 stars"></label>
              <label class="full" for="star2" title="Kinda bad - 2 stars"></label>
              <label class="half" for="star1half" title="Meh - 1.5 stars"></label>
              <label class="full" for="star1" title="Sucks big time - 1 star"></label>
              <label class="half" for="starhalf" title="Sucks big time - 0.5 stars"></label>
              </fieldset>
              <p class="valoration">${valoracion} <span>(${valoraciones} valoraciones)</span></p>
      </div>
      </div>
      <div class="col-md-9">
              <h4>${e.nombreCompleto}<span class="title">${e.especialidad}</span><span class="location">${_ubigeoPeLi.find(o=>o.ub === e.ubigeo).nom} - Lima</span></h4>
      <p>${e.acerca}</p>
      <button class="btn btn-default btn-black" type="button" onclick="verPerfil('${nomLink}')">VER PERFIL</button>
      <button class="btn btn-default btn-white" type="button" onclick="verPerfilDirectServices('${nomLink}')">VER SERVICIOS</button>
      </div>
      </div>
          `));
        });
      }

      function verPerfil(nomLink){
        window.location.href = _ctx + 'p/trainer/'+nomLink;
      }

      function verPerfilDirectServices(nomLink){
        window.location.href = _ctx + 'p/trainer/'+nomLink+"#service";

      }
    </script>
  </body>
</html>

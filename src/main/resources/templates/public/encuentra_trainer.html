<!DOCTYPE html>
<html lang="en" id="extr-page"
      xmlns:th="http://www.thymeleaf.org"
      th:with="version = ${#servletContext.getAttribute('version')}">
<head>
  <title>Encuentra al trainer indicado para ti | Fitness | Runfit</title>
  <th:block th:insert="html-commons/p/meta :: fg-meta"></th:block>
  <th:block th:insert="html-commons/p/css  :: fg-css"></th:block>
  </head>
  <body>
    <nav th:replace="html-commons/p/header :: fg-header"></nav>
    <div th:replace="html-commons/reu-login :: fg-login"></div>
    <div id="wrapper" class="wrapper">
      <div class="section banner home">
        <div class="bg-image"><img class="banner-home" th:src="@{/img/public/trainers-shadow.jpg}+'?'+${version}"/></div>
      </div>
      <section class="encuentra-tu-coach">
        <form id="frm_registro">
          <div class="container">
          <h1>Elige al especialista<span>Que se adecue a tus necesidades</span></h1>
          <div class="row">
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>BÚSQUEDA POR NOMBRE</label>
                <input class="form-control" type="text" id="Nombres" name="Nombres" placeholder="Nombre del trainer">
              </div>
            </div>
            <div class="col-md-4">  
              <div class="form-group">
                <label>UTILIZA PALABRAS CLAVES</label>
                <input class="form-control" id="Acerca" name="Acerca" type="text" placeholder="Ejem: Trail, circuitos, funcional...">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>UBICACIÓN</label>
                <select class="form-control" id="Ubigeo" name="Ubigeo">
                  <option value="">Seleccione</option>
                  <option th:each="dis : ${peLiDistritos.lstDis}" th:value="${dis.cod}" th:text="${dis.ubNombre}"></option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>SERVICIOS</label>
                <input class="form-control" type="text" id="Servicio" name="Servicio" placeholder="Nombre del servicio">
              </div>
            </div>
            <div class="col-md-8 view-only-desktop">
              <div class="form-group">
                <label>¿DONDE QUIERES ENTRENAR?</label>
                <ul class="checks">
                  <li>
                    <div class="chk-content">Al aire libre
                      <input type="checkbox" name="FormaTrabajo" value="ai"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">Personalizado
                      <input type="checkbox" name="FormaTrabajo" value="pe"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">En grupo
                      <input type="checkbox" name="FormaTrabajo" value="eg"><span class="checkmark"></span>
                    </div>
                  </li>
                  <li>
                    <div class="chk-content">Online
                      <input type="checkbox" name="FormaTrabajo" value="on"><span class="checkmark"></span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">   
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>SEXO</label>
                <select class="form-control" id="Sexo" name="Sexo">
                  <option value="">Seleccione</option>
                  <option value="1">Masculino</option>
                  <option value="2">Femenino</option>
                </select>
              </div>
            </div>
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>IDIOMAS QUE DOMINA EL ASESOR</label>
                <select class="form-control" id="Idiomas" name="Idiomas" multiple="multiple" style="height: 100px">
                  <option value="">Seleccione</option>
                  <option th:each="ln : ${idiomas}" th:value="${ln.iso}" th:text="${ln.nombre}"></option>
                </select>
              </div>
            </div>
            <div class="col-md-4 view-only-desktop">
              <div class="form-group">
                <label>NIVEL DE RENDIMIENTO</label>
                <select class="form-control" id="Niveles" name="Niveles" multiple="multiple" style="height: 100px">
                  <option value="">Seleccione</option>
                  <option value="pr">Principiante</option>
                  <option value="in">Intermedio</option>
                  <option value="av">Avanzado</option>
                  <option value="pf">Profesional</option>
                </select>
              </div>
            </div>
          </div>
          <br/>
          <div class="row">
            <div class="col-md-6">
              <button id="btnLimpiar" class="btn btn-default btn-white view-only-desktop" type="button">LIMPIAR TODO</button>
            </div>
            <div class="col-md-6 text-right">
              <button class="btn btn-default btn-black" type="button" id="btnBuscar">BUSCAR</button>
            </div>
            <div class="col-md-12 dv-rows hidden" style="font-size: 1.6em;padding: 10px;color: #303030;">
              <i class="fa fa-check fa-fw"></i> Se han encontrado <span id="Rows"></span> coincidencias</div>
            </div>
          <div id="Trainers">

          </div>
        </div>
        </form>
      </section>
    </div>
    <footer th:replace="html-commons/p/footer :: fg-footer"></footer>
    <th:block th:insert="html-commons/p/js :: fg-js"></th:block>
    <script th:inline="javascript">
      const btnLimpiar = document.getElementById('btnLimpiar');
      const btnBuscar = document.getElementById('btnBuscar');
      const initLimit = 10;
      const initOffset = 0;
      let totalRows = 0;
      let queryParams = resetPagination();
      function resetPagination(){
        return {
          limit: initLimit,
          offset: initOffset
        };
      }

      (function(){
        btnLimpiar.addEventListener('click', ()=>{
            //All reset
            limpiarMainForm();
            busquedaDinamica();
        });
        btnBuscar.addEventListener('click', busquedaDinamica);
        init();
      })();

      function init(){
        onlyBusquedaDinamica();
        scrollEventBusquedaAutomatica();
      }

      function busquedaDinamica(){
        //Clean resulset
        document.querySelector('#Trainers').innerHTML = "";
        totalRows = 0;
        queryParams = resetPagination();
        onlyBusquedaDinamica();
      }

      function onlyBusquedaDinamica(){
        const d = getFormData($('#frm_registro'));
        d.niveles = Array.from(document.getElementById('Niveles').querySelectorAll("option:checked"),e=>e.value).join('|');
        d.idiomas = Array.from(document.getElementById('Idiomas').querySelectorAll("option:checked"),e=>e.value).join('|');
        d.formasTrabajo = getValuesConcatInpCheckbox('FormaTrabajo');

        Object.keys(d).forEach(key=>{
          if(!d[key]){
            delete d[key];
          };
        })
        if(d.hasOwnProperty("ubigeo")){
          d.ubigeo = "1501"+d.ubigeo;//Prefix Lima Perú
        }

        d.limit = queryParams.limit;
        d.offset = queryParams.offset;

        d.valoracion = 1.1;

        $.ajax({
          type: 'GET',
          url: _ctx + 'p/trainer/find/dinamico',
          dataType: 'json',
          data: d,
          blockLoading: false,
          noOne: true,
          success: function (res) {
            if(res.length === 0){
              const noOne = document.createElement('div');
              noOne.className = "";
              noOne.style.fontSize = "1.5em";
              noOne.style.color = "#a8fa00";
              noOne.style.padding = "15px 0px";
              noOne.innerHTML = "<i class='fa fa-info-circle fa-fw'></i>No se ha encontrado ninguna coincidencia. Pruebe nuevamente con otra búsqueda";
              document.getElementById('Trainers').appendChild(noOne);
              document.querySelector('.dv-rows').classList.add('hidden');
            }else{
              recrearListado(res);
              totalRows = res[0].rows;
              document.querySelector('#Rows').textContent = totalRows;
              document.querySelector('.dv-rows').classList.remove('hidden');
            }
          }, error: (xhr) => {
            exception(xhr);
          }, complete: () => {

          }
        })
      }

      function recrearListado(arr){
        const divTrainers = document.getElementById('Trainers');
        arr.forEach((e)=>{
          const acLen = e.acerca.length;
          if(acLen > 540){
            e.acerca = e.acerca.slice(0, 540).trim();
              if(e.acerca.lastIndexOf(".") === e.acerca.length-1){
                e.acerca = slice.replace(0,539);
              }
              e.acerca += "...";
          };
          const ttId = e.tipoTrainerId;

          const objValoracion = getValoracion(e.canPerValoracion, e.totalValoracion);
          const nomLink = e.nomPag;
          let nombreFinal = "";
          if(ttId == 1){
            nombreFinal = e.nombreCompleto;
          }else{
            nombreFinal = e.nombreCompleto.includes(' xxx') ? e.nombreCompleto.substring(0, e.nombreCompleto.indexOf(" xxx")) : e.nombreCompleto;
          }

          divTrainers.appendChild(htmlStringToElement(`
          <div class="group-trainer row">
              <div class="col-md-3 pad-0">
              <div class="avatar-form">
              <div class="avatar-form-content"><img src="https://s3-us-west-2.amazonaws.com/rf-profile-imgs/trainer/${e.id}/${e.nomImgPerfil}" style="max-height: 100%;height: 100%; !important;"></div>
              <fieldset class="text-center">
                <div class="rating-holder">
                  <div class="c-rating c-rating--regular" data-rating-value="${objValoracion.aproximadaValoracion}">
                    <button disabled="disabled">1</button>
                    <button disabled="disabled">2</button>
                    <button disabled="disabled">3</button>
                    <button disabled="disabled">4</button>
                    <button disabled="disabled">5</button>
                  </div>
                </div>
              </fieldset>
              <p class="valoration">${objValoracion.exactaValoracion.toFixed(1)} <span>(${objValoracion.valoraciones} valoraciones)</span></p>
      </div>
      </div>
      <div class="col-md-9">
              <h4>${nombreFinal}<span class="title">${ttId == 1 ? e.especialidad : ''}</span><span class="location">${_ubigeoPeLi.find(o=>o.ub === e.ubigeo).nom} - Lima</span></h4>
      <p>${e.acerca}</p>
      <button class="btn btn-default btn-black" type="button" onclick="verPerfil('${nomLink}')">VER PERFIL</button>
      <button class="btn btn-default btn-white" type="button" onclick="verPerfilDirectServices('${nomLink}')">VER SERVICIOS</button>
      </div>
      </div>
          `));
        });
      }

      function verPerfil(nomLink){
        window.location.href = _ctx + 'p/trainer/'+nomLink;
      }

      function verPerfilDirectServices(nomLink){
        window.location.href = _ctx + 'p/trainer/'+nomLink+"#service";

      }

      function scrollEventBusquedaAutomatica(){
        const footHeight = document.querySelector('.footer').clientHeight + 300;
        $(window).scroll(function() {

          if($(window).scrollTop() + $(window).height() > $(document).height() - footHeight) {
            if(totalRows> queryParams.offset + queryParams.limit){
                queryParams.offset = queryParams.offset + queryParams.limit;
                onlyBusquedaDinamica();
            }
          }
        });
      }
    </script>
  </body>
</html>
